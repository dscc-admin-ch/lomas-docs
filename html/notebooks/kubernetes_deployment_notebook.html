<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kubernetes Service Deployment &mdash; Lomas 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=d45e8c67"></script>
        <script src="../_static/doctools.js?v=9a2dae69"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Lomas
              <img src="../_static/logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                develop
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Client</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../client_quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../client_examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../client_errors.html">Errors</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Server</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../server_deployment.html">Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../server_administration.html">Administration</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Documentation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../CONTRIBUTING.html">Tips for developers</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Lomas</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Kubernetes Service Deployment</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/notebooks/kubernetes_deployment_notebook.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Kubernetes-Service-Deployment">
<h1>Kubernetes Service Deployment<a class="headerlink" href="#Kubernetes-Service-Deployment" title="Link to this heading"></a></h1>
<p>This notebook showcases how a data owner could set up the service on a kubernetes cluster, add and make their data available to certain user. In addition, it also shows how to set up user sessions.</p>
<p>We use helm charts to deploy the service on a kubernetes cluster.</p>
<section id="Building-the-container-images">
<h2>Building the container images<a class="headerlink" href="#Building-the-container-images" title="Link to this heading"></a></h2>
<p>The Lomas service is comprised of a fastapi server and a MongoDB database for keeping state about users and datasets. While the database image is public, the server image must first be built and pushed to a registry. This also holds true for the client session image.</p>
<p>As a preparation step, first make sure to have a docker registry at your disposal and log into that:</p>
<p><code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">login</span></code> (=&gt; use personal token from dockerhub, has to be done only once)</p>
<p>This must be done only once, the local docker credential helper will store the token locally.</p>
<p>Let’s now build the server image and push it to the registry. For this, we need to move from the root of this repository to <code class="docutils literal notranslate"><span class="pre">server/</span></code> and run <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">build</span></code>:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span><span class="nb">cd</span><span class="w"> </span>..<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>docker<span class="w"> </span>build<span class="w"> </span>--target<span class="w"> </span>lomas_server<span class="w"> </span>-t<span class="w"> </span>&lt;your_registry&gt;/lomas_server:latest<span class="w"> </span>.
<span class="o">!</span><span class="nb">cd</span><span class="w"> </span>..<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>docker<span class="w"> </span>push<span class="w"> </span>&lt;your_registry&gt;/lomas_server:latest
</pre></div>
</div>
</div>
<p>This will copy the server code as well as some dummy datasets into the server image.</p>
<p>As a second step, let’s do the same for the client image:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span><span class="nb">cd</span><span class="w"> </span>../../client/<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>docker<span class="w"> </span>build<span class="w"> </span>--target<span class="w"> </span>lomas_client<span class="w"> </span>-t<span class="w"> </span>&lt;your_registry&gt;/lomas_client:latest<span class="w"> </span>.
<span class="o">!</span><span class="nb">cd</span><span class="w"> </span>../../client/<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>docker<span class="w"> </span>push<span class="w"> </span>&lt;your_registry&gt;/lomas_client:latest
</pre></div>
</div>
</div>
</section>
<section id="Starting-the-service">
<h2>Starting the service<a class="headerlink" href="#Starting-the-service" title="Link to this heading"></a></h2>
<p>We use a Helm chart to deploy the service on a Kubernetes cluster. For the next part of this notebook to work correctly, one must have access to a Kubernetes cluster with sufficient rights and an environment with correctly configured helm and kubectl command line tools.</p>
<p>The lomas-server chart is located at <code class="docutils literal notranslate"><span class="pre">server/deploy/helm/charts/lomas_server</span></code>, let us change our working directory to this location.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[90]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;../deploy/helm/charts/lomas_server&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">values.yaml</span></code> file contains all the configuration values for the service. We must now update the <code class="docutils literal notranslate"><span class="pre">image.repository</span></code> field to the one we pushed the server container image to. One can also change the url to which the service will be published with <code class="docutils literal notranslate"><span class="pre">ingress.hosts[0].host</span></code> and <code class="docutils literal notranslate"><span class="pre">ingress.tls.hosts[0]</span></code> (or disable this feature by setting <code class="docutils literal notranslate"><span class="pre">ingress.enabled</span></code> to <code class="docutils literal notranslate"><span class="pre">False</span></code>).</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>=&gt; Update `values.yaml` file
</pre></div>
</div>
<p>Password and secrets will be deployed in kubernetes secrets and other service parameters will be deployed in configMaps.</p>
<p>As previously stated, the service is made up of a server and a MongoDB database. Before installing the chart, we must thus first download the MongoDB dependency.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[91]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>helm<span class="w"> </span>dependency<span class="w"> </span>update
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Saving 1 charts
Downloading mongodb from repo oci://registry-1.docker.io/bitnamicharts
Pulled: registry-1.docker.io/bitnamicharts/mongodb:13.18.1
Digest: sha256:f3b2a691537260044746bc4a8898e9ae68e8c29864639737b6da920f99aebe97
Deleting outdated charts
</pre></div></div>
</div>
<p>Now the chart is ready to be installed, so let the magic happen!</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[92]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>helm<span class="w"> </span>install<span class="w"> </span>-f<span class="w"> </span>values.yaml<span class="w"> </span>lomas-service<span class="w"> </span>.
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
W0918 07:49:26.628394  768420 warnings.go:70] annotation &#34;kubernetes.io/ingress.class&#34; is deprecated, please use &#39;spec.ingressClassName&#39; instead
NAME: lomas-service
LAST DEPLOYED: Mon Sep 18 07:49:24 2023
NAMESPACE: user-paulineml
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
1. Get the application URL by running these commands:
  https://sdd-demo.lab.sspcloud.fr/
</pre></div></div>
</div>
<p>The installation notes show the url at which the server is exposed. One can have a look at the server state by checking <code class="docutils literal notranslate"><span class="pre">&lt;server_url&gt;/state</span></code> and the api docummentation by visiting <code class="docutils literal notranslate"><span class="pre">&lt;server_url&gt;/docs</span></code> in their browser.</p>
<p>One can also check the whether the service started without issues by using the <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">all</span></code> command as well as inspecting the server logs with <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">logs</span> <span class="pre">&lt;server-pod-name&gt;</span></code></p>
</section>
<section id="Starting-the-client-session">
<h2>Starting the client session<a class="headerlink" href="#Starting-the-client-session" title="Link to this heading"></a></h2>
<p>The client deployment Helm chart is located in another directory, so let’s again move our working directory</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;../../../../../client/deploy/helm/charts/lomas_client&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Again, one needs to update the <code class="docutils literal notranslate"><span class="pre">values.yaml</span></code> file with the desired values. The important fields are <code class="docutils literal notranslate"><span class="pre">ingress.hosts[0].host</span></code> and <code class="docutils literal notranslate"><span class="pre">ingress.tls.hosts[0]</span></code> for the url, <code class="docutils literal notranslate"><span class="pre">password</span></code> for the user session and <code class="docutils literal notranslate"><span class="pre">image.repository</span></code> for specifying the previously built image. Make sure to change the <code class="docutils literal notranslate"><span class="pre">nameOverride</span></code>, <code class="docutils literal notranslate"><span class="pre">fullnameOverride</span></code> and url when deploying multiple client images.</p>
<p><code class="docutils literal notranslate"><span class="pre">=&gt;</span> <span class="pre">update</span> <span class="pre">values.yaml</span></code></p>
<p>Similarly to the server deployment, let’s install the client Helm chart:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>helm<span class="w"> </span>install<span class="w"> </span>-f<span class="w"> </span>values.yaml<span class="w"> </span>lomas-client<span class="w"> </span>.
</pre></div>
</div>
</div>
<p>The user session should now be available at the specified url, just type the password and you are in!</p>
<p>If the service was started with developper mode to false, move to the <code class="docutils literal notranslate"><span class="pre">admin_notebook</span></code> to learn how to administer your freshly deployed service.</p>
<p>Once users and datasets have been added to the service, one can start to experiment with it. The URL to use for the service is the one defined in the server <code class="docutils literal notranslate"><span class="pre">values.yaml</span></code> file.</p>
</section>
<section id="Stopping-the-service">
<h2>Stopping the service<a class="headerlink" href="#Stopping-the-service" title="Link to this heading"></a></h2>
<p>To tear down the service, we simply execute the command <code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">uninstall</span> <span class="pre">lomas-service</span></code>. The same goes for the client session with <code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">uninstall</span> <span class="pre">lomas-client</span></code>.</p>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, DSCC.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      Version: latest
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      
      <dl>
        <dt>Languages</dt>
          
            <dd><a href="https://dscc-admin-ch.github.io/lomas-docs//index.html">en</a></dd>
          
      </dl>
      
      
      <dl>
        <dt>Versions</dt>
        
          <dd><a href="https://dscc-admin-ch.github.io/lomas-docs//index.html">latest</a></dd>
        
          <dd><a href="https://dscc-admin-ch.github.io/lomas-docs//master/en/index.html">master</a></dd>
        
          <dd><a href="https://dscc-admin-ch.github.io/lomas-docs//develop/en/index.html">develop</a></dd>
        
      </dl>
      
      <br>
      </dl>
    </div>
  </div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>