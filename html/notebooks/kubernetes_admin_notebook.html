<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Secure Data Disclosure on Kubernetes: Deployment and Server Administration &mdash; Lomas 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=d45e8c67"></script>
        <script src="../_static/doctools.js?v=9a2dae69"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Lomas
              <img src="../_static/logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                develop
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Client</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../client_quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../client_examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../client_errors.html">Errors</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Server</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../server_deployment.html">Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../server_administration.html">Administration</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Documentation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../CONTRIBUTING.html">Tips for developers</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Lomas</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Secure Data Disclosure on Kubernetes: Deployment and Server Administration</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/notebooks/kubernetes_admin_notebook.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Secure-Data-Disclosure-on-Kubernetes:-Deployment-and-Server-Administration">
<h1>Secure Data Disclosure on Kubernetes: Deployment and Server Administration<a class="headerlink" href="#Secure-Data-Disclosure-on-Kubernetes:-Deployment-and-Server-Administration" title="Link to this heading"></a></h1>
<p>This notebook showcases how a data owner could set up the service on a kubernetes cluster, add and make their data available to certain user. We will do this in a step by step fashion.</p>
<section id="Deploying-the-service">
<h2>Deploying the service<a class="headerlink" href="#Deploying-the-service" title="Link to this heading"></a></h2>
<section id="Building-the-server-image">
<h3>Building the server image<a class="headerlink" href="#Building-the-server-image" title="Link to this heading"></a></h3>
<p>The Lomas service is comprised of a fastapi server and a MongoDB database for keeping state and administration. While the database image is public, the server image must first be built and pushed to a registry.</p>
<p>NOTE: For now, the server configuration file is copied and put into the server container. This is of course not practical (and not safe, since the configuration file contains passwords and secrets) and will be updated in future versions. The <code class="docutils literal notranslate"><span class="pre">config/example_config.yaml</span></code> is the one that is copied into the container. One has to change it and rebuild+push the server container in order to change the server configuration.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># !docker login (=&gt; use personal token from dockerhub, has to be done only once)</span>

<span class="o">!</span><span class="nb">cd</span><span class="w"> </span>..<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>docker<span class="w"> </span>build<span class="w"> </span>--target<span class="w"> </span>lomas_server<span class="w"> </span>-t<span class="w"> </span>&lt;your_registry&gt;/lomas_serverer:latest<span class="w"> </span>.
<span class="o">!</span><span class="nb">cd</span><span class="w"> </span>..<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>docker<span class="w"> </span>push<span class="w"> </span>&lt;your_registry&gt;/lomas-server:latest
</pre></div>
</div>
</div>
</section>
<section id="Deploying-the-service-Helm-chart">
<h3>Deploying the service Helm chart<a class="headerlink" href="#Deploying-the-service-Helm-chart" title="Link to this heading"></a></h3>
<p>We use a Helm chart to deploy the service on a Kubernetes cluster. The lomas-server chart is located at <code class="docutils literal notranslate"><span class="pre">deploy/helm/charts/lomas_server</span></code>, let us change our working directory to this location.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;../deploy/helm/charts/lomas_server&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">values.yaml</span></code> file contains all the configuration values for the service. We must now update the <code class="docutils literal notranslate"><span class="pre">image.repository</span></code> field to the one we pushed the server container image to. One can also change the url to which the service will be published with <code class="docutils literal notranslate"><span class="pre">ingress.hosts[0].host</span></code> (or disable this feature by setting <code class="docutils literal notranslate"><span class="pre">ingress.enabled</span></code> to <code class="docutils literal notranslate"><span class="pre">False</span></code>).</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>=&gt; Update `values.yaml` file
</pre></div>
</div>
<p>As previously stated, the service is made up of a server and a MongoDB database. Before installing the chart, we must thus first download that dependency.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>helm<span class="w"> </span>dependency<span class="w"> </span>update
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Saving 1 charts
Downloading mongodb from repo oci://registry-1.docker.io/bitnamicharts
Save error occurred:  could not download oci://registry-1.docker.io/bitnamicharts/mongodb: failed to copy: httpReadSeeker: failed open: failed to do request: Get &#34;https://production.cloudflare.docker.com/registry-v2/docker/registry/v2/blobs/sha256/95/953b9cef6799e942255a1d5edcb7cb7508230fb57e4d68d02e27aed4b1694eaf/data?verify=1701701776-w82MF1fkjhlDOYT4WuSJHicDe5c%3D&#34;: dial tcp: lookup production.cloudflare.docker.com on 169.254.25.10:53: server misbehaving
Error: could not download oci://registry-1.docker.io/bitnamicharts/mongodb: failed to copy: httpReadSeeker: failed open: failed to do request: Get &#34;https://production.cloudflare.docker.com/registry-v2/docker/registry/v2/blobs/sha256/95/953b9cef6799e942255a1d5edcb7cb7508230fb57e4d68d02e27aed4b1694eaf/data?verify=1701701776-w82MF1fkjhlDOYT4WuSJHicDe5c%3D&#34;: dial tcp: lookup production.cloudflare.docker.com on 169.254.25.10:53: server misbehaving
</pre></div></div>
</div>
<p>Now the chart is ready to be installed, so let the magic happen!</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>helm<span class="w"> </span>install<span class="w"> </span>-f<span class="w"> </span>values.yaml<span class="w"> </span>lomas-service<span class="w"> </span>.
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Error: INSTALLATION FAILED: cannot re-use a name that is still in use
</pre></div></div>
</div>
<p>The installation notes show the url at which the server is exposed. One can have a look at the api docummentation by visiting <code class="docutils literal notranslate"><span class="pre">&lt;server_url&gt;/docs</span></code></p>
<p>One can also check the whether the service started error free by using the <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">all</span></code> command as well as inspecting the server logs with <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">logs</span> <span class="pre">&lt;server-pod-name&gt;</span></code></p>
</section>
</section>
<section id="Administering-the-service-by-accessing-the-mongoDB">
<h2>Administering the service by accessing the mongoDB<a class="headerlink" href="#Administering-the-service-by-accessing-the-mongoDB" title="Link to this heading"></a></h2>
<p>Let’s switch directory again and move to the administration script.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;../../../../lomas_server/&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>To interact with the mongoDB, we will need to install a few libraries. Let’s do so by creating a python virtual environment and installing the dependencies listed in <code class="docutils literal notranslate"><span class="pre">admin_requirements.txt</span></code></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>-r<span class="w"> </span>../admin_requirements.txt
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Requirement already satisfied: annotated-types==0.5.0 in /home/onyxia/work/.venv/lib/python3.10/site-packages (from -r ../admin_requirements.txt (line 1)) (0.5.0)
Requirement already satisfied: anyio==3.7.1 in /home/onyxia/work/.venv/lib/python3.10/site-packages (from -r ../admin_requirements.txt (line 2)) (3.7.1)
Requirement already satisfied: asttokens==2.4.0 in /home/onyxia/work/.venv/lib/python3.10/site-packages (from -r ../admin_requirements.txt (line 3)) (2.4.0)
Requirement already satisfied: backcall==0.2.0 in /home/onyxia/work/.venv/lib/python3.10/site-packages (from -r ../admin_requirements.txt (line 4)) (0.2.0)
Collecting boto3 (from -r ../admin_requirements.txt (line 5))
  Downloading boto3-1.34.40-py3-none-any.whl.metadata (6.6 kB)
Requirement already satisfied: comm==0.1.4 in /home/onyxia/work/.venv/lib/python3.10/site-packages (from -r ../admin_requirements.txt (line 6)) (0.1.4)
Requirement already satisfied: debugpy==1.7.0 in /home/onyxia/work/.venv/lib/python3.10/site-packages (from -r ../admin_requirements.txt (line 7)) (1.7.0)
Requirement already satisfied: decorator==5.1.1 in /home/onyxia/work/.venv/lib/python3.10/site-packages (from -r ../admin_requirements.txt (line 8)) (5.1.1)
Requirement already satisfied: dnspython==2.4.2 in /home/onyxia/work/.venv/lib/python3.10/site-packages (from -r ../admin_requirements.txt (line 9)) (2.4.2)
Requirement already satisfied: executing==1.2.0 in /home/onyxia/work/.venv/lib/python3.10/site-packages (from -r ../admin_requirements.txt (line 10)) (1.2.0)
Requirement already satisfied: fastapi==0.103.1 in /home/onyxia/work/.venv/lib/python3.10/site-packages (from -r ../admin_requirements.txt (line 11)) (0.103.1)
Requirement already satisfied: idna==3.4 in /home/onyxia/work/.venv/lib/python3.10/site-packages (from -r ../admin_requirements.txt (line 12)) (3.4)
Requirement already satisfied: ipykernel==6.25.2 in /home/onyxia/work/.venv/lib/python3.10/site-packages (from -r ../admin_requirements.txt (line 13)) (6.25.2)
Requirement already satisfied: ipython==8.15.0 in /home/onyxia/work/.venv/lib/python3.10/site-packages (from -r ../admin_requirements.txt (line 14)) (8.15.0)
Requirement already satisfied: jedi==0.19.0 in /home/onyxia/work/.venv/lib/python3.10/site-packages (from -r ../admin_requirements.txt (line 15)) (0.19.0)
Requirement already satisfied: jupyter_client==8.3.1 in /home/onyxia/work/.venv/lib/python3.10/site-packages (from -r ../admin_requirements.txt (line 16)) (8.3.1)
Requirement already satisfied: jupyter_core==5.3.1 in /home/onyxia/work/.venv/lib/python3.10/site-packages (from -r ../admin_requirements.txt (line 17)) (5.3.1)
Requirement already satisfied: matplotlib-inline==0.1.6 in /home/onyxia/work/.venv/lib/python3.10/site-packages (from -r ../admin_requirements.txt (line 18)) (0.1.6)
Requirement already satisfied: nest-asyncio==1.5.7 in /home/onyxia/work/.venv/lib/python3.10/site-packages (from -r ../admin_requirements.txt (line 19)) (1.5.7)
Requirement already satisfied: packaging==23.1 in /home/onyxia/work/.venv/lib/python3.10/site-packages (from -r ../admin_requirements.txt (line 20)) (23.1)
Requirement already satisfied: parso==0.8.3 in /home/onyxia/work/.venv/lib/python3.10/site-packages (from -r ../admin_requirements.txt (line 21)) (0.8.3)
Requirement already satisfied: pexpect==4.8.0 in /home/onyxia/work/.venv/lib/python3.10/site-packages (from -r ../admin_requirements.txt (line 22)) (4.8.0)
Requirement already satisfied: pickleshare==0.7.5 in /home/onyxia/work/.venv/lib/python3.10/site-packages (from -r ../admin_requirements.txt (line 23)) (0.7.5)
Requirement already satisfied: platformdirs==3.10.0 in /home/onyxia/work/.venv/lib/python3.10/site-packages (from -r ../admin_requirements.txt (line 24)) (3.10.0)
Requirement already satisfied: prompt-toolkit==3.0.39 in /home/onyxia/work/.venv/lib/python3.10/site-packages (from -r ../admin_requirements.txt (line 25)) (3.0.39)
Requirement already satisfied: psutil==5.9.5 in /home/onyxia/work/.venv/lib/python3.10/site-packages (from -r ../admin_requirements.txt (line 26)) (5.9.5)
Requirement already satisfied: ptyprocess==0.7.0 in /home/onyxia/work/.venv/lib/python3.10/site-packages (from -r ../admin_requirements.txt (line 27)) (0.7.0)
Requirement already satisfied: pure-eval==0.2.2 in /home/onyxia/work/.venv/lib/python3.10/site-packages (from -r ../admin_requirements.txt (line 28)) (0.2.2)
Requirement already satisfied: pyaml==23.9.5 in /home/onyxia/work/.venv/lib/python3.10/site-packages (from -r ../admin_requirements.txt (line 29)) (23.9.5)
Requirement already satisfied: pydantic==2.3.0 in /home/onyxia/work/.venv/lib/python3.10/site-packages (from -r ../admin_requirements.txt (line 30)) (2.3.0)
Requirement already satisfied: pydantic_core==2.6.3 in /home/onyxia/work/.venv/lib/python3.10/site-packages (from -r ../admin_requirements.txt (line 31)) (2.6.3)
Requirement already satisfied: Pygments==2.16.1 in /home/onyxia/work/.venv/lib/python3.10/site-packages (from -r ../admin_requirements.txt (line 32)) (2.16.1)
Requirement already satisfied: pymongo==4.5.0 in /home/onyxia/work/.venv/lib/python3.10/site-packages (from -r ../admin_requirements.txt (line 33)) (4.5.0)
Requirement already satisfied: python-dateutil==2.8.2 in /home/onyxia/work/.venv/lib/python3.10/site-packages (from -r ../admin_requirements.txt (line 34)) (2.8.2)
Requirement already satisfied: PyYAML==6.0.1 in /home/onyxia/work/.venv/lib/python3.10/site-packages (from -r ../admin_requirements.txt (line 35)) (6.0.1)
Requirement already satisfied: pyzmq==25.1.1 in /home/onyxia/work/.venv/lib/python3.10/site-packages (from -r ../admin_requirements.txt (line 36)) (25.1.1)
Requirement already satisfied: six==1.16.0 in /home/onyxia/work/.venv/lib/python3.10/site-packages (from -r ../admin_requirements.txt (line 37)) (1.16.0)
Requirement already satisfied: sniffio==1.3.0 in /home/onyxia/work/.venv/lib/python3.10/site-packages (from -r ../admin_requirements.txt (line 38)) (1.3.0)
Requirement already satisfied: stack-data==0.6.2 in /home/onyxia/work/.venv/lib/python3.10/site-packages (from -r ../admin_requirements.txt (line 39)) (0.6.2)
Requirement already satisfied: starlette==0.27.0 in /home/onyxia/work/.venv/lib/python3.10/site-packages (from -r ../admin_requirements.txt (line 40)) (0.27.0)
Requirement already satisfied: tornado==6.3.3 in /home/onyxia/work/.venv/lib/python3.10/site-packages (from -r ../admin_requirements.txt (line 41)) (6.3.3)
Requirement already satisfied: traitlets==5.9.0 in /home/onyxia/work/.venv/lib/python3.10/site-packages (from -r ../admin_requirements.txt (line 42)) (5.9.0)
Requirement already satisfied: typing_extensions==4.7.1 in /home/onyxia/work/.venv/lib/python3.10/site-packages (from -r ../admin_requirements.txt (line 43)) (4.7.1)
Requirement already satisfied: wcwidth==0.2.6 in /home/onyxia/work/.venv/lib/python3.10/site-packages (from -r ../admin_requirements.txt (line 44)) (0.2.6)
Requirement already satisfied: exceptiongroup in /home/onyxia/work/.venv/lib/python3.10/site-packages (from anyio==3.7.1-&gt;-r ../admin_requirements.txt (line 2)) (1.2.0)
Collecting botocore&lt;1.35.0,&gt;=1.34.40 (from boto3-&gt;-r ../admin_requirements.txt (line 5))
  Downloading botocore-1.34.40-py3-none-any.whl.metadata (5.7 kB)
Collecting jmespath&lt;2.0.0,&gt;=0.7.1 (from boto3-&gt;-r ../admin_requirements.txt (line 5))
  Downloading jmespath-1.0.1-py3-none-any.whl (20 kB)
Collecting s3transfer&lt;0.11.0,&gt;=0.10.0 (from boto3-&gt;-r ../admin_requirements.txt (line 5))
  Downloading s3transfer-0.10.0-py3-none-any.whl.metadata (1.7 kB)
Collecting urllib3&lt;2.1,&gt;=1.25.4 (from botocore&lt;1.35.0,&gt;=1.34.40-&gt;boto3-&gt;-r ../admin_requirements.txt (line 5))
  Downloading urllib3-2.0.7-py3-none-any.whl.metadata (6.6 kB)
Downloading boto3-1.34.40-py3-none-any.whl (139 kB)
   <span class="ansi-black-intense-fg">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> <span class="ansi-green-fg">139.3/139.3 kB</span> <span class="ansi-red-fg">8.2 MB/s</span> eta <span class="ansi-cyan-fg">0:00:00</span>
Downloading botocore-1.34.40-py3-none-any.whl (12.0 MB)
   <span class="ansi-black-intense-fg">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> <span class="ansi-green-fg">12.0/12.0 MB</span> <span class="ansi-red-fg">58.2 MB/s</span> eta <span class="ansi-cyan-fg">0:00:00</span>00:0100:01
Downloading s3transfer-0.10.0-py3-none-any.whl (82 kB)
   <span class="ansi-black-intense-fg">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> <span class="ansi-green-fg">82.1/82.1 kB</span> <span class="ansi-red-fg">3.2 MB/s</span> eta <span class="ansi-cyan-fg">0:00:00</span>
Downloading urllib3-2.0.7-py3-none-any.whl (124 kB)
   <span class="ansi-black-intense-fg">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> <span class="ansi-green-fg">124.2/124.2 kB</span> <span class="ansi-red-fg">25.4 MB/s</span> eta <span class="ansi-cyan-fg">0:00:00</span>
Installing collected packages: urllib3, jmespath, botocore, s3transfer, boto3
Successfully installed boto3-1.34.40 botocore-1.34.40 jmespath-1.0.1 s3transfer-0.10.0 urllib3-2.0.7
</pre></div></div>
</div>
<p>We should now have the required environment to interact with the admin database.</p>
<section id="Preparing-the-database">
<h3>Preparing the database<a class="headerlink" href="#Preparing-the-database" title="Link to this heading"></a></h3>
<p>You can visualise all the options offered by the database by running the command <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">mongodb_admin.py</span> <span class="pre">--help</span></code>. We will go through through each of them in the rest of the notebook.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>--help
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
usage: MongoDB administration script for the user database [-h]
                                                           {add_user,add_user_with_budget,del_user,add_dataset_to_user,del_dataset_to_user,set_budget_field,set_may_query,show_user,create_users_collection,add_dataset,add_datasets,drop_collection,show_collection}
                                                           ...

options:
  -h, --help            show this help message and exit

subcommands:
  {add_user,add_user_with_budget,del_user,add_dataset_to_user,del_dataset_to_user,set_budget_field,set_may_query,show_user,create_users_collection,add_dataset,add_datasets,drop_collection,show_collection}
                        user database administration operations
    add_user            add user to users collection
    add_user_with_budget
                        add user with budget to users collection
    del_user            delete user from users collection
    add_dataset_to_user
                        add dataset with initialized budget values for a user
    del_dataset_to_user
                        delete dataset for user in users collection
    set_budget_field    set budget field to given value for given user and
                        dataset
    set_may_query       set may query field to given value for given user
    show_user           show all metadata of user
    create_users_collection
                        create users collection from yaml file
    add_dataset         set in which database the dataset is stored
    add_datasets        create dataset to database type collection
    drop_collection     delete collection from database
    show_collection     print the users collection
</pre></div></div>
</div>
<p>Let’s first make sure the database is empty and in a clean state.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>drop_collection<span class="w"> </span>--collection<span class="w"> </span>datasets
<span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>drop_collection<span class="w"> </span>--collection<span class="w"> </span>metadata
<span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>drop_collection<span class="w"> </span>--collection<span class="w"> </span>users
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Deleted collection datasets.
Deleted collection metadata.
Deleted collection users.
</pre></div></div>
</div>
</section>
<section id="Datasets-(add-and-drop)">
<h3>Datasets (add and drop)<a class="headerlink" href="#Datasets-(add-and-drop)" title="Link to this heading"></a></h3>
<p>We first need to set the dataset meta-information. For each dataset, 2 informations are required: - the type of database in which the dataset is stored - a path to the metadata of the dataset (stored as a yaml file).</p>
<p>To later perform query on the dataset, metadata are required. In this secure server the metadata information is expected to be in the same format as <a class="reference external" href="https://docs.smartnoise.org/sql/metadata.html#dictionary-format">SmartnoiseSQL dictionary format</a>, where among other, there is information about all the available columns, their type, bound values (see Smartnoise page for more details). It is also expected to be in a <code class="docutils literal notranslate"><span class="pre">yaml</span></code> file.</p>
<p>These information (dataset name, dataset type and metadata path) are stored in the <code class="docutils literal notranslate"><span class="pre">datasets</span></code> collection. Then for each dataset, its metadata is fetched from its <code class="docutils literal notranslate"><span class="pre">yaml</span></code> file and stored in a collection named <code class="docutils literal notranslate"><span class="pre">metadata</span></code>.</p>
<p>We then check that there is indeed no data in the dataset and metadata collections yet:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>show_collection<span class="w"> </span>--collection<span class="w"> </span>datasets
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>show_collection<span class="w"> </span>--collection<span class="w"> </span>metadata
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[]
</pre></div></div>
</div>
<p>We can add <strong>one dataset</strong> with its name, and informations on where to load the dataset and metadata file.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>add_dataset<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;PENGUIN&quot;</span><span class="w"> </span>-db<span class="w"> </span><span class="s2">&quot;REMOTE_HTTP_DB&quot;</span><span class="w"> </span>-d_url<span class="w"> </span><span class="s2">&quot;https://raw.githubusercontent.com/mwaskom/seaborn-data/master/penguins.csv&quot;</span><span class="w"> </span>-m_db<span class="w"> </span><span class="s2">&quot;LOCAL_DB&quot;</span><span class="w"> </span>-mp<span class="w"> </span><span class="s2">&quot;../data/collections/metadata/penguin_metadata.yaml&quot;</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Added dataset PENGUIN with database REMOTE_HTTP_DB and associated metadata.
</pre></div></div>
</div>
<p>We can also show an example of how to add a dataset and its metadata stored on an S3 server. The access key id and secret access id should be updated depending on the location of the file.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>add_dataset<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;TITANIC&quot;</span><span class="w"> </span>-db<span class="w"> </span><span class="s2">&quot;S3_DB&quot;</span><span class="w"> </span>-s3b<span class="w"> </span><span class="s2">&quot;example&quot;</span><span class="w"> </span>-s3k<span class="w"> </span><span class="s2">&quot;data/titanic.csv&quot;</span><span class="w"> </span>-s3_url<span class="w"> </span><span class="s2">&quot;https://api-lomas-minio.lab.sspcloud.fr&quot;</span><span class="w"> </span>-s3_ak<span class="w"> </span><span class="s2">&quot;admin&quot;</span><span class="w"> </span>-s3_sak<span class="w"> </span><span class="s2">&quot;admin123&quot;</span><span class="w"> </span>-m_db<span class="w"> </span><span class="s2">&quot;S3_DB&quot;</span><span class="w"> </span>-m_s3b<span class="w"> </span><span class="s2">&quot;example&quot;</span><span class="w"> </span>-m_s3k<span class="w"> </span><span class="s2">&quot;metadata/titanic_metadata.yaml&quot;</span><span class="w"> </span>-m_s3_url<span class="w"> </span><span class="s2">&quot;https://api-lomas-minio.lab.sspcloud.fr&quot;</span><span class="w"> </span>-m_s3_ak<span class="w"> </span><span class="s2">&quot;admin&quot;</span><span class="w"> </span>-m_s3_sak<span class="w"> </span><span class="s2">&quot;admin123&quot;</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Added dataset TITANIC with database S3_DB and associated metadata.
</pre></div></div>
</div>
<p>We can now see the dataset and metadata collection with the Iris dataset:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>show_collection<span class="w"> </span>--collection<span class="w"> </span>datasets
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[{&#39;dataset_name&#39;: &#39;TITANIC&#39;, &#39;database_type&#39;: &#39;S3_DB&#39;, &#39;s3_bucket&#39;: &#39;example&#39;, &#39;s3_key&#39;: &#39;data/titanic.csv&#39;, &#39;endpoint_url&#39;: &#39;https://api-sdd-minio.lab.sspcloud.fr&#39;, &#39;aws_access_key_id&#39;: &#39;admin&#39;, &#39;aws_secret_access_key&#39;: &#39;admin123&#39;}]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>show_collection<span class="w"> </span>--collection<span class="w"> </span>metadata
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[{&#39;TITANIC&#39;: {&#39;&#39;: {&#39;Schema&#39;: {&#39;Table&#39;: {&#39;max_ids&#39;: 1, &#39;PassengerId&#39;: {&#39;type&#39;: &#39;int&#39;, &#39;lower&#39;: 1}, &#39;Pclass&#39;: {&#39;type&#39;: &#39;int&#39;, &#39;lower&#39;: 1, &#39;upper&#39;: 3}, &#39;Name&#39;: {&#39;type&#39;: &#39;string&#39;}, &#39;Sex&#39;: {&#39;type&#39;: &#39;string&#39;, &#39;cardinality&#39;: 2, &#39;categories&#39;: [&#39;male&#39;, &#39;female&#39;]}, &#39;Age&#39;: {&#39;type&#39;: &#39;float&#39;, &#39;lower&#39;: 0.1, &#39;upper&#39;: 100.0}, &#39;SibSp&#39;: {&#39;type&#39;: &#39;int&#39;, &#39;lower&#39;: 0}, &#39;Parch&#39;: {&#39;type&#39;: &#39;int&#39;, &#39;lower&#39;: 0}, &#39;Ticket&#39;: {&#39;type&#39;: &#39;string&#39;}, &#39;Fare&#39;: {&#39;type&#39;: &#39;float&#39;, &#39;lower&#39;: 0.0}, &#39;Cabin&#39;: {&#39;type&#39;: &#39;string&#39;}, &#39;Embarked&#39;: {&#39;type&#39;: &#39;string&#39;, &#39;cardinality&#39;: 3, &#39;categories&#39;: [&#39;C&#39;, &#39;Q&#39;, &#39;S&#39;]}, &#39;Survived&#39;: {&#39;type&#39;: &#39;boolean&#39;}, &#39;row_privacy&#39;: True}}}, &#39;engine&#39;: &#39;csv&#39;}}]
</pre></div></div>
</div>
<p>Or a path to a yaml file which contains all these informations to do <strong>multiple datasets</strong> in one command:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[49]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>add_datasets<span class="w"> </span>--path<span class="w"> </span>../data/collections/dataset_collection.yaml<span class="w"> </span>-c
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Cleaning done.

Added datasets collection from yaml at ../data/collections/dataset_collection.yaml.
Added metadata of IRIS dataset.
Added metadata of PENGUIN dataset.
Added metadata of TITANIC dataset.
Added metadata of FSO_INCOME_SYNTHETIC dataset.
</pre></div></div>
</div>
<p>The argument <em>-c</em> or <em>–clean</em> allows you to clear the current dataset collection before adding your collection.</p>
<p>By default, <em>add_datasets</em> will only add new dataset found from the collection provided.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>add_datasets<span class="w"> </span>--path<span class="w"> </span>../data/collections/dataset_collection.yaml
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Metadata already exist. Use the command -om to overwrite with new values.
Metadata already exist. Use the command -om to overwrite with new values.
Metadata already exist. Use the command -om to overwrite with new values.
Metadata already exist. Use the command -om to overwrite with new values.
</pre></div></div>
</div>
<p>Arguments :</p>
<p><em>-od</em> / <em>–overwrite_datasets</em> : Overwrite the values for <strong>exisiting datasets</strong> with the values provided in the yaml.</p>
<p><em>-om</em> / <em>–overwrite_metadata</em> : Overwrite the values for <strong>exisiting metadata</strong> with the values provided in the yaml.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add new datasets/metadata, update existing datasets</span>
<span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>add_datasets<span class="w"> </span>--path<span class="w"> </span>../data/collections/dataset_collection.yaml<span class="w"> </span>-od
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Datasets updated with values from yaml at ../data/collections/dataset_collection.yaml.
Metadata already exist. Use the command -om to overwrite with new values.
Metadata already exist. Use the command -om to overwrite with new values.
Metadata already exist. Use the command -om to overwrite with new values.
Metadata already exist. Use the command -om to overwrite with new values.
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add new datasets/metadata, update existing metadata</span>
<span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>add_datasets<span class="w"> </span>--path<span class="w"> </span>../data/collections/dataset_collection.yaml<span class="w"> </span>-om
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Metadata updated for dataset : IRIS.
Metadata updated for dataset : PENGUIN.
Metadata updated for dataset : TITANIC.
Metadata updated for dataset : FSO_INCOME_SYNTHETIC.
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add new datasets/metadata, update existing datasets &amp; metadata</span>
<span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>add_datasets<span class="w"> </span>--path<span class="w"> </span>../data/collections/dataset_collection.yaml<span class="w"> </span>-od<span class="w"> </span>-om
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Datasets updated with values from yaml at ../data/collections/dataset_collection.yaml.
Metadata updated for dataset : IRIS.
Metadata updated for dataset : PENGUIN.
Metadata updated for dataset : TITANIC.
Metadata updated for dataset : FSO_INCOME_SYNTHETIC.
</pre></div></div>
</div>
<p>Let’s see all the dataset collection:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>show_collection<span class="w"> </span>--collection<span class="w"> </span>datasets
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[{&#39;dataset_name&#39;: &#39;IRIS&#39;, &#39;database_type&#39;: &#39;REMOTE_HTTP_DB&#39;, &#39;dataset_url&#39;: &#39;https://raw.githubusercontent.com/mwaskom/seaborn-data/master/iris.csv&#39;, &#39;metadata&#39;: {&#39;database_type&#39;: &#39;LOCAL_DB&#39;, &#39;metadata_path&#39;: &#39;../data/collections/metadata/iris_metadata.yaml&#39;}}, {&#39;dataset_name&#39;: &#39;PENGUIN&#39;, &#39;database_type&#39;: &#39;REMOTE_HTTP_DB&#39;, &#39;dataset_url&#39;: &#39;https://raw.githubusercontent.com/mwaskom/seaborn-data/master/penguins.csv&#39;, &#39;metadata&#39;: {&#39;database_type&#39;: &#39;LOCAL_DB&#39;, &#39;metadata_path&#39;: &#39;../data/collections/metadata/penguin_metadata.yaml&#39;}}, {&#39;dataset_name&#39;: &#39;TITANIC&#39;, &#39;database_type&#39;: &#39;S3_DB&#39;, &#39;s3_bucket&#39;: &#39;example&#39;, &#39;s3_key&#39;: &#39;data/titanic.csv&#39;, &#39;endpoint_url&#39;: &#39;https://api-sdd-minio.lab.sspcloud.fr&#39;, &#39;aws_access_key_id&#39;: &#39;admin&#39;, &#39;aws_secret_access_key&#39;: &#39;admin123&#39;, &#39;metadata&#39;: {&#39;database_type&#39;: &#39;LOCAL_DB&#39;, &#39;metadata_path&#39;: &#39;../data/collections/metadata/titanic_metadata.yaml&#39;}}, {&#39;dataset_name&#39;: &#39;FSO_INCOME_SYNTHETIC&#39;, &#39;database_type&#39;: &#39;LOCAL_DB&#39;, &#39;dataset_path&#39;: &#39;../data/datasets/income_synthetic_data.csv&#39;, &#39;metadata&#39;: {&#39;database_type&#39;: &#39;LOCAL_DB&#39;, &#39;metadata_path&#39;: &#39;../data/collections/metadata/fso_income_synthetic_metadata.yaml&#39;}}]
</pre></div></div>
</div>
<p>Finally let’s have a look at the stored metadata:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>show_collection<span class="w"> </span>--collection<span class="w"> </span>metadata
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[{&#39;IRIS&#39;: {&#39;&#39;: {&#39;Schema&#39;: {&#39;Table&#39;: {&#39;max_ids&#39;: 1, &#39;petal_length&#39;: {&#39;type&#39;: &#39;float&#39;, &#39;lower&#39;: 0.5, &#39;upper&#39;: 10.0}, &#39;petal_width&#39;: {&#39;type&#39;: &#39;float&#39;, &#39;lower&#39;: 0.05, &#39;upper&#39;: 5.0}, &#39;row_privacy&#39;: True, &#39;sepal_length&#39;: {&#39;type&#39;: &#39;float&#39;, &#39;lower&#39;: 2.0, &#39;upper&#39;: 10.0}, &#39;sepal_width&#39;: {&#39;type&#39;: &#39;float&#39;, &#39;lower&#39;: 1.0, &#39;upper&#39;: 6.0}, &#39;species&#39;: {&#39;type&#39;: &#39;string&#39;, &#39;cardinality&#39;: 3, &#39;categories&#39;: [&#39;setosa&#39;, &#39;versicolor&#39;, &#39;virginica&#39;]}}}}, &#39;engine&#39;: &#39;csv&#39;}}, {&#39;PENGUIN&#39;: {&#39;&#39;: {&#39;Schema&#39;: {&#39;Table&#39;: {&#39;max_ids&#39;: 1, &#39;row_privacy&#39;: True, &#39;censor_dims&#39;: False, &#39;species&#39;: {&#39;type&#39;: &#39;string&#39;, &#39;cardinality&#39;: 3, &#39;categories&#39;: [&#39;Adelie&#39;, &#39;Chinstrap&#39;, &#39;Gentoo&#39;]}, &#39;island&#39;: {&#39;type&#39;: &#39;string&#39;, &#39;cardinality&#39;: 3, &#39;categories&#39;: [&#39;Torgersen&#39;, &#39;Biscoe&#39;, &#39;Dream&#39;]}, &#39;bill_length_mm&#39;: {&#39;type&#39;: &#39;float&#39;, &#39;lower&#39;: 30.0, &#39;upper&#39;: 65.0}, &#39;bill_depth_mm&#39;: {&#39;type&#39;: &#39;float&#39;, &#39;lower&#39;: 13.0, &#39;upper&#39;: 23.0}, &#39;flipper_length_mm&#39;: {&#39;type&#39;: &#39;float&#39;, &#39;lower&#39;: 150.0, &#39;upper&#39;: 250.0}, &#39;body_mass_g&#39;: {&#39;type&#39;: &#39;float&#39;, &#39;lower&#39;: 2000.0, &#39;upper&#39;: 7000.0}, &#39;sex&#39;: {&#39;type&#39;: &#39;string&#39;, &#39;cardinality&#39;: 2, &#39;categories&#39;: [&#39;MALE&#39;, &#39;FEMALE&#39;]}}}}, &#39;engine&#39;: &#39;csv&#39;}}, {&#39;TITANIC&#39;: {&#39;&#39;: {&#39;Schema&#39;: {&#39;Table&#39;: {&#39;max_ids&#39;: 1, &#39;PassengerId&#39;: {&#39;type&#39;: &#39;int&#39;, &#39;lower&#39;: 1}, &#39;Pclass&#39;: {&#39;type&#39;: &#39;int&#39;, &#39;lower&#39;: 1, &#39;upper&#39;: 3}, &#39;Name&#39;: {&#39;type&#39;: &#39;string&#39;}, &#39;Sex&#39;: {&#39;type&#39;: &#39;string&#39;, &#39;cardinality&#39;: 2, &#39;categories&#39;: [&#39;male&#39;, &#39;female&#39;]}, &#39;Age&#39;: {&#39;type&#39;: &#39;float&#39;, &#39;lower&#39;: 0.1, &#39;upper&#39;: 100.0}, &#39;SibSp&#39;: {&#39;type&#39;: &#39;int&#39;, &#39;lower&#39;: 0}, &#39;Parch&#39;: {&#39;type&#39;: &#39;int&#39;, &#39;lower&#39;: 0}, &#39;Ticket&#39;: {&#39;type&#39;: &#39;string&#39;}, &#39;Fare&#39;: {&#39;type&#39;: &#39;float&#39;, &#39;lower&#39;: 0.0}, &#39;Cabin&#39;: {&#39;type&#39;: &#39;string&#39;}, &#39;Embarked&#39;: {&#39;type&#39;: &#39;string&#39;, &#39;cardinality&#39;: 3, &#39;categories&#39;: [&#39;C&#39;, &#39;Q&#39;, &#39;S&#39;]}, &#39;Survived&#39;: {&#39;type&#39;: &#39;boolean&#39;}, &#39;row_privacy&#39;: True}}}, &#39;engine&#39;: &#39;csv&#39;}}, {&#39;FSO_INCOME_SYNTHETIC&#39;: {&#39;&#39;: {&#39;Schema&#39;: {&#39;Table&#39;: {&#39;max_ids&#39;: 1, &#39;region&#39;: {&#39;type&#39;: &#39;int&#39;}, &#39;eco_branch&#39;: {&#39;type&#39;: &#39;int&#39;}, &#39;profession&#39;: {&#39;type&#39;: &#39;int&#39;}, &#39;education&#39;: {&#39;type&#39;: &#39;int&#39;}, &#39;age&#39;: {&#39;type&#39;: &#39;int&#39;}, &#39;sex&#39;: {&#39;type&#39;: &#39;int&#39;}, &#39;income&#39;: {&#39;type&#39;: &#39;float&#39;, &#39;lower&#39;: 1000, &#39;upper&#39;: 100000}}}}, &#39;engine&#39;: &#39;csv&#39;}}]
</pre></div></div>
</div>
</section>
<section id="Users">
<h3>Users<a class="headerlink" href="#Users" title="Link to this heading"></a></h3>
<section id="Adding-users">
<h4>Adding users<a class="headerlink" href="#Adding-users" title="Link to this heading"></a></h4>
<p>Let’s see which users are alreay loaded:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>show_collection<span class="w"> </span>--collection<span class="w"> </span>users
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[]
</pre></div></div>
</div>
<p>And now let’s add few users.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>add_user_with_budget<span class="w"> </span>--user<span class="w"> </span><span class="s1">&#39;Mrs. Daisy&#39;</span><span class="w"> </span>--dataset<span class="w"> </span><span class="s1">&#39;IRIS&#39;</span><span class="w"> </span>--epsilon<span class="w"> </span><span class="m">10</span>.0<span class="w"> </span>--delta<span class="w"> </span><span class="m">0</span>.001
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Added access to user Mrs. Daisy with dataset IRIS, budget epsilon 10.0 and delta 0.001.
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>add_user_with_budget<span class="w"> </span>--user<span class="w"> </span><span class="s1">&#39;Mr. Coldheart&#39;</span><span class="w"> </span>--dataset<span class="w"> </span><span class="s1">&#39;PENGUIN&#39;</span><span class="w"> </span>--epsilon<span class="w"> </span><span class="m">10</span>.0<span class="w"> </span>--delta<span class="w"> </span><span class="m">0</span>.001
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Added access to user Mr. Coldheart with dataset PENGUIN, budget epsilon 10.0 and delta 0.001.
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>add_user_with_budget<span class="w"> </span>--user<span class="w"> </span><span class="s1">&#39;Lord McFreeze&#39;</span><span class="w"> </span>--dataset<span class="w"> </span><span class="s1">&#39;PENGUIN&#39;</span><span class="w"> </span>--epsilon<span class="w"> </span><span class="m">10</span>.0<span class="w"> </span>--delta<span class="w"> </span><span class="m">0</span>.001
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Added access to user Lord McFreeze with dataset PENGUIN, budget epsilon 10.0 and delta 0.001.
</pre></div></div>
</div>
<p>Users must all have different names, otherwise you will have an error and nothing will be done:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>add_user_with_budget<span class="w"> </span>--user<span class="w"> </span><span class="s1">&#39;Lord McFreeze&#39;</span><span class="w"> </span>--dataset<span class="w"> </span><span class="s1">&#39;IRIS&#39;</span><span class="w"> </span>--epsilon<span class="w"> </span><span class="m">10</span>.0<span class="w"> </span>--delta<span class="w"> </span><span class="m">0</span>.001
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Traceback (most recent call last):
  File &#34;/home/onyxia/work/sdd-poc-server/server/src/mongodb_admin.py&#34;, line 549, in &lt;module&gt;
    args.func(args)
  File &#34;/home/onyxia/work/sdd-poc-server/server/src/mongodb_admin.py&#34;, line 47, in add_user_with_budget
    raise ValueError(&#34;Cannot add user because already exists. &#34;)
ValueError: Cannot add user because already exists.
</pre></div></div>
</div>
<p>If you want to add another dataset access to an existing user, just use the function <code class="docutils literal notranslate"><span class="pre">add_dataset_to_user</span></code> command.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>add_dataset_to_user<span class="w"> </span>--user<span class="w"> </span><span class="s1">&#39;Lord McFreeze&#39;</span><span class="w"> </span>--dataset<span class="w"> </span><span class="s1">&#39;IRIS&#39;</span><span class="w"> </span>--epsilon<span class="w"> </span><span class="m">5</span>.0<span class="w"> </span>--delta<span class="w"> </span><span class="m">0</span>.005
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Added access to dataset IRIS to user Lord McFreeze with budget epsilon 5.0 and delta 0.005.
</pre></div></div>
</div>
<p>Alternatively, you can create a user without assigned dataset and then add dataset in another command.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>add_user<span class="w"> </span>--user<span class="w"> </span><span class="s1">&#39;Madame Frostina&#39;</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Added user Madame Frostina.
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>add_dataset_to_user<span class="w"> </span>--user<span class="w"> </span><span class="s1">&#39;Madame Frostina&#39;</span><span class="w"> </span>--dataset<span class="w"> </span><span class="s1">&#39;IRIS&#39;</span><span class="w"> </span>--epsilon<span class="w"> </span><span class="m">5</span>.0<span class="w"> </span>--delta<span class="w"> </span><span class="m">0</span>.005
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Added access to dataset IRIS to user Madame Frostina with budget epsilon 5.0 and delta 0.005.
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>add_dataset_to_user<span class="w"> </span>--user<span class="w"> </span><span class="s1">&#39;Madame Frostina&#39;</span><span class="w"> </span>--dataset<span class="w"> </span><span class="s1">&#39;PENGUIN&#39;</span><span class="w"> </span>--epsilon<span class="w"> </span><span class="m">5</span>.0<span class="w"> </span>--delta<span class="w"> </span><span class="m">0</span>.005
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Added access to dataset PENGUIN to user Madame Frostina with budget epsilon 5.0 and delta 0.005.
</pre></div></div>
</div>
<p>And we can also modify existing the total budget of a user:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>add_user_with_budget<span class="w"> </span>--user<span class="w"> </span><span class="s1">&#39;Dr. Antartica&#39;</span><span class="w"> </span>--dataset<span class="w"> </span><span class="s1">&#39;PENGUIN&#39;</span><span class="w"> </span>--epsilon<span class="w"> </span><span class="m">10</span>.0<span class="w"> </span>--delta<span class="w"> </span><span class="m">0</span>.001
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Added access to user Dr. Antartica with dataset PENGUIN, budget epsilon 10.0 and delta 0.001.
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>set_budget_field<span class="w"> </span>--user<span class="w"> </span><span class="s1">&#39;Dr. Antartica&#39;</span><span class="w"> </span>--dataset<span class="w"> </span><span class="s1">&#39;PENGUIN&#39;</span><span class="w"> </span>--field<span class="w"> </span>initial_epsilon<span class="w"> </span>--value<span class="w"> </span><span class="m">20</span>.0
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Set budget of Dr. Antartica for dataset PENGUIN of initial_epsilon to 20.0.
</pre></div></div>
</div>
<p>Let’s see the current state of the database:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>show_collection<span class="w"> </span>--collection<span class="w"> </span>users
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[{&#39;user_name&#39;: &#39;Mrs. Daisy&#39;, &#39;may_query&#39;: True, &#39;datasets_list&#39;: [{&#39;dataset_name&#39;: &#39;IRIS&#39;, &#39;initial_epsilon&#39;: 10.0, &#39;initial_delta&#39;: 0.001, &#39;total_spent_epsilon&#39;: 0.0, &#39;total_spent_delta&#39;: 0.0}]}, {&#39;user_name&#39;: &#39;Mr. Coldheart&#39;, &#39;may_query&#39;: True, &#39;datasets_list&#39;: [{&#39;dataset_name&#39;: &#39;PENGUIN&#39;, &#39;initial_epsilon&#39;: 10.0, &#39;initial_delta&#39;: 0.001, &#39;total_spent_epsilon&#39;: 0.0, &#39;total_spent_delta&#39;: 0.0}]}, {&#39;user_name&#39;: &#39;Lord McFreeze&#39;, &#39;may_query&#39;: True, &#39;datasets_list&#39;: [{&#39;dataset_name&#39;: &#39;PENGUIN&#39;, &#39;initial_epsilon&#39;: 10.0, &#39;initial_delta&#39;: 0.001, &#39;total_spent_epsilon&#39;: 0.0, &#39;total_spent_delta&#39;: 0.0}, {&#39;dataset_name&#39;: &#39;IRIS&#39;, &#39;initial_epsilon&#39;: 5.0, &#39;initial_delta&#39;: 0.005, &#39;total_spent_epsilon&#39;: 0.0, &#39;total_spent_delta&#39;: 0.0}]}, {&#39;user_name&#39;: &#39;Madame Frostina&#39;, &#39;may_query&#39;: True, &#39;datasets_list&#39;: [{&#39;dataset_name&#39;: &#39;IRIS&#39;, &#39;initial_epsilon&#39;: 5.0, &#39;initial_delta&#39;: 0.005, &#39;total_spent_epsilon&#39;: 0.0, &#39;total_spent_delta&#39;: 0.0}, {&#39;dataset_name&#39;: &#39;PENGUIN&#39;, &#39;initial_epsilon&#39;: 5.0, &#39;initial_delta&#39;: 0.005, &#39;total_spent_epsilon&#39;: 0.0, &#39;total_spent_delta&#39;: 0.0}]}, {&#39;user_name&#39;: &#39;Dr. Antartica&#39;, &#39;may_query&#39;: True, &#39;datasets_list&#39;: [{&#39;dataset_name&#39;: &#39;PENGUIN&#39;, &#39;initial_epsilon&#39;: 20.0, &#39;initial_delta&#39;: 0.001, &#39;total_spent_epsilon&#39;: 0.0, &#39;total_spent_delta&#39;: 0.0}]}]
</pre></div></div>
</div>
<p>Do not hesitate to re-run this command after every other command to ensure that everything runs as expected.</p>
</section>
<section id="Removing-users">
<h4>Removing users<a class="headerlink" href="#Removing-users" title="Link to this heading"></a></h4>
<p>You have just heard that the penguin named Coldheart might have malicious intentions and decide to remove his access until an investigation has been carried out. To ensure that he is not allowed to do any more queries, run the following command:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>set_may_query<span class="w"> </span>--user<span class="w"> </span><span class="s1">&#39;Mr. Coldheart&#39;</span><span class="w"> </span>--value<span class="w"> </span>False
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Set user Mr. Coldheart may query.
</pre></div></div>
</div>
<p>Now, he won’t be able to do any query (unless you re-run the query with –value True).</p>
<p>A few days have passed and the investigation reveals that he was aiming to do unethical research, you can remove his dataset by doing:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>del_dataset_to_user<span class="w"> </span>--user<span class="w"> </span><span class="s1">&#39;Mr. Coldheart&#39;</span><span class="w"> </span>--dataset<span class="w"> </span><span class="s1">&#39;PENGUIN&#39;</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Remove access to dataset PENGUIN from user Mr. Coldheart.
</pre></div></div>
</div>
<p>Or delete him completely from the codebase:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>del_user<span class="w"> </span>--user<span class="w"> </span><span class="s1">&#39;Mr. Coldheart&#39;</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Deleted user Mr. Coldheart.
</pre></div></div>
</div>
<p>Let’s see the resulting users:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>show_collection<span class="w"> </span>--collection<span class="w"> </span>users
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[{&#39;user_name&#39;: &#39;Mrs. Daisy&#39;, &#39;may_query&#39;: True, &#39;datasets_list&#39;: [{&#39;dataset_name&#39;: &#39;IRIS&#39;, &#39;initial_epsilon&#39;: 10.0, &#39;initial_delta&#39;: 0.001, &#39;total_spent_epsilon&#39;: 0.0, &#39;total_spent_delta&#39;: 0.0}]}, {&#39;user_name&#39;: &#39;Lord McFreeze&#39;, &#39;may_query&#39;: True, &#39;datasets_list&#39;: [{&#39;dataset_name&#39;: &#39;PENGUIN&#39;, &#39;initial_epsilon&#39;: 10.0, &#39;initial_delta&#39;: 0.001, &#39;total_spent_epsilon&#39;: 0.0, &#39;total_spent_delta&#39;: 0.0}, {&#39;dataset_name&#39;: &#39;IRIS&#39;, &#39;initial_epsilon&#39;: 5.0, &#39;initial_delta&#39;: 0.005, &#39;total_spent_epsilon&#39;: 0.0, &#39;total_spent_delta&#39;: 0.0}]}, {&#39;user_name&#39;: &#39;Madame Frostina&#39;, &#39;may_query&#39;: True, &#39;datasets_list&#39;: [{&#39;dataset_name&#39;: &#39;IRIS&#39;, &#39;initial_epsilon&#39;: 5.0, &#39;initial_delta&#39;: 0.005, &#39;total_spent_epsilon&#39;: 0.0, &#39;total_spent_delta&#39;: 0.0}, {&#39;dataset_name&#39;: &#39;PENGUIN&#39;, &#39;initial_epsilon&#39;: 5.0, &#39;initial_delta&#39;: 0.005, &#39;total_spent_epsilon&#39;: 0.0, &#39;total_spent_delta&#39;: 0.0}]}, {&#39;user_name&#39;: &#39;Dr. Antartica&#39;, &#39;may_query&#39;: True, &#39;datasets_list&#39;: [{&#39;dataset_name&#39;: &#39;PENGUIN&#39;, &#39;initial_epsilon&#39;: 20.0, &#39;initial_delta&#39;: 0.001, &#39;total_spent_epsilon&#39;: 0.0, &#39;total_spent_delta&#39;: 0.0}]}]
</pre></div></div>
</div>
</section>
<section id="Changing-the-budget">
<h4>Changing the budget<a class="headerlink" href="#Changing-the-budget" title="Link to this heading"></a></h4>
<p>You also change your mind about the budget allowed to Lord McFreeze and give him a bit more on the penguin dataset.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>set_budget_field<span class="w"> </span>--user<span class="w"> </span><span class="s1">&#39;Lord McFreeze&#39;</span><span class="w"> </span>--dataset<span class="w"> </span><span class="s1">&#39;PENGUIN&#39;</span><span class="w"> </span>--field<span class="w"> </span>initial_epsilon<span class="w"> </span>--value<span class="w"> </span><span class="m">15</span>.0
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Set budget of Lord McFreeze for dataset PENGUIN of initial_epsilon to 15.0.
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>set_budget_field<span class="w"> </span>--user<span class="w"> </span><span class="s1">&#39;Lord McFreeze&#39;</span><span class="w"> </span>--dataset<span class="w"> </span><span class="s1">&#39;PENGUIN&#39;</span><span class="w"> </span>--field<span class="w"> </span>initial_delta<span class="w"> </span>--value<span class="w"> </span><span class="m">0</span>.005
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Set budget of Lord McFreeze for dataset PENGUIN of initial_delta to 0.005.
</pre></div></div>
</div>
<p>Let’s check all our changes by looking at the state of the database:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>show_collection<span class="w"> </span>--collection<span class="w"> </span>users
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[{&#39;user_name&#39;: &#39;Mrs. Daisy&#39;, &#39;may_query&#39;: True, &#39;datasets_list&#39;: [{&#39;dataset_name&#39;: &#39;IRIS&#39;, &#39;initial_epsilon&#39;: 10.0, &#39;initial_delta&#39;: 0.001, &#39;total_spent_epsilon&#39;: 0.0, &#39;total_spent_delta&#39;: 0.0}]}, {&#39;user_name&#39;: &#39;Lord McFreeze&#39;, &#39;may_query&#39;: True, &#39;datasets_list&#39;: [{&#39;dataset_name&#39;: &#39;PENGUIN&#39;, &#39;initial_epsilon&#39;: 15.0, &#39;initial_delta&#39;: 0.005, &#39;total_spent_epsilon&#39;: 0.0, &#39;total_spent_delta&#39;: 0.0}, {&#39;dataset_name&#39;: &#39;IRIS&#39;, &#39;initial_epsilon&#39;: 5.0, &#39;initial_delta&#39;: 0.005, &#39;total_spent_epsilon&#39;: 0.0, &#39;total_spent_delta&#39;: 0.0}]}, {&#39;user_name&#39;: &#39;Madame Frostina&#39;, &#39;may_query&#39;: True, &#39;datasets_list&#39;: [{&#39;dataset_name&#39;: &#39;IRIS&#39;, &#39;initial_epsilon&#39;: 5.0, &#39;initial_delta&#39;: 0.005, &#39;total_spent_epsilon&#39;: 0.0, &#39;total_spent_delta&#39;: 0.0}, {&#39;dataset_name&#39;: &#39;PENGUIN&#39;, &#39;initial_epsilon&#39;: 5.0, &#39;initial_delta&#39;: 0.005, &#39;total_spent_epsilon&#39;: 0.0, &#39;total_spent_delta&#39;: 0.0}]}, {&#39;user_name&#39;: &#39;Dr. Antartica&#39;, &#39;may_query&#39;: True, &#39;datasets_list&#39;: [{&#39;dataset_name&#39;: &#39;PENGUIN&#39;, &#39;initial_epsilon&#39;: 20.0, &#39;initial_delta&#39;: 0.001, &#39;total_spent_epsilon&#39;: 0.0, &#39;total_spent_delta&#39;: 0.0}]}]
</pre></div></div>
</div>
</section>
</section>
<section id="Finally,-everything-can-actually-be-loaded-directly-from-a-single-file">
<h3>Finally, everything can actually be loaded directly from a single file<a class="headerlink" href="#Finally,-everything-can-actually-be-loaded-directly-from-a-single-file" title="Link to this heading"></a></h3>
<p>Let’s delete the existing user collection first:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>drop_collection<span class="w"> </span>--collection<span class="w"> </span>users
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Deleted collection users.
</pre></div></div>
</div>
<p>Is is now empty:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>show_collection<span class="w"> </span>--collection<span class="w"> </span>users
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[]
</pre></div></div>
</div>
<p>We add the data based on a yaml file:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>create_users_collection<span class="w"> </span>--path<span class="w"> </span>../data/collections/user_collection.yaml
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Added user data from yaml at ../data/collections/user_collection.yaml.
</pre></div></div>
</div>
<p>By default, <em>create_users_collection</em> will only add new users to the database.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>create_users_collection<span class="w"> </span>--path<span class="w"> </span>../data/collections/user_collection.yaml
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
No new users added, they already exist in the server
</pre></div></div>
</div>
<p>If you want to clean the current users collection and replace it, you can use the argument <em>–clean</em>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>create_users_collection<span class="w"> </span>--path<span class="w"> </span>../data/collections/user_collection.yaml<span class="w"> </span>--clean
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Cleaning done.

Added user data from yaml at ../data/collections/user_collection.yaml.
</pre></div></div>
</div>
<p>If you want to add new users and update the existing ones in your collection, you can use the argument <em>–overwrite</em>. This will make sure to add new users if they do not exist and replace values from existing users with the collection provided.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>create_users_collection<span class="w"> </span>--path<span class="w"> </span>../data/collections/user_collection.yaml<span class="w"> </span>--overwrite
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Existing users updated.
No new users added, they already exist in the server
</pre></div></div>
</div>
<p>And let’s see the resulting collection:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>show_collection<span class="w"> </span>--collection<span class="w"> </span>users
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[{&#39;user_name&#39;: &#39;Alice&#39;, &#39;may_query&#39;: True, &#39;datasets_list&#39;: [{&#39;dataset_name&#39;: &#39;IRIS&#39;, &#39;initial_epsilon&#39;: 10, &#39;initial_delta&#39;: 0.0001, &#39;total_spent_epsilon&#39;: 1, &#39;total_spent_delta&#39;: 1e-06}, {&#39;dataset_name&#39;: &#39;PENGUIN&#39;, &#39;initial_epsilon&#39;: 5, &#39;initial_delta&#39;: 0.0005, &#39;total_spent_epsilon&#39;: 0.2, &#39;total_spent_delta&#39;: 1e-07}]}, {&#39;user_name&#39;: &#39;Dr. Antartica&#39;, &#39;may_query&#39;: True, &#39;datasets_list&#39;: [{&#39;dataset_name&#39;: &#39;PENGUIN&#39;, &#39;initial_epsilon&#39;: 45, &#39;initial_delta&#39;: 0.005, &#39;total_spent_epsilon&#39;: 0, &#39;total_spent_delta&#39;: 0}]}, {&#39;user_name&#39;: &#39;Dr. FSO&#39;, &#39;may_query&#39;: True, &#39;datasets_list&#39;: [{&#39;dataset_name&#39;: &#39;FSO_INCOME_SYNTHETIC&#39;, &#39;initial_epsilon&#39;: 45, &#39;initial_delta&#39;: 0.005, &#39;total_spent_epsilon&#39;: 0, &#39;total_spent_delta&#39;: 0}]}, {&#39;user_name&#39;: &#39;Bob&#39;, &#39;may_query&#39;: True, &#39;datasets_list&#39;: [{&#39;dataset_name&#39;: &#39;IRIS&#39;, &#39;initial_epsilon&#39;: 10, &#39;initial_delta&#39;: 0.0001, &#39;total_spent_epsilon&#39;: 0, &#39;total_spent_delta&#39;: 0}]}, {&#39;user_name&#39;: &#39;Jack&#39;, &#39;may_query&#39;: True, &#39;datasets_list&#39;: [{&#39;dataset_name&#39;: &#39;TITANIC&#39;, &#39;initial_epsilon&#39;: 45, &#39;initial_delta&#39;: 0.2, &#39;total_spent_epsilon&#39;: 0, &#39;total_spent_delta&#39;: 0}]}]
</pre></div></div>
</div>
</section>
</section>
<section id="Archives-of-queries">
<h2>Archives of queries<a class="headerlink" href="#Archives-of-queries" title="Link to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>python<span class="w"> </span>mongodb_admin.py<span class="w"> </span>show_collection<span class="w"> </span>--collection<span class="w"> </span>queries_archives
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[]
</pre></div></div>
</div>
</section>
<section id="Stopping-the-service:-Let's-not-do-it-right-now!">
<h2>Stopping the service: Let’s not do it right now!<a class="headerlink" href="#Stopping-the-service:-Let's-not-do-it-right-now!" title="Link to this heading"></a></h2>
<p>To tear down the service, we simply execute the command <code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">uninstall</span> <span class="pre">lomas-service</span></code></p>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, DSCC.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      Version: latest
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      
      <dl>
        <dt>Languages</dt>
          
            <dd><a href="https://dscc-admin-ch.github.io/lomas-docs/index.html">en</a></dd>
          
      </dl>
      
      
      <dl>
        <dt>Versions</dt>
        
          <dd><a href="https://dscc-admin-ch.github.io/lomas-docs/index.html">latest</a></dd>
        
          <dd><a href="https://dscc-admin-ch.github.io/lomas-docs/master/en/index.html">master</a></dd>
        
          <dd><a href="https://dscc-admin-ch.github.io/lomas-docs/develop/en/index.html">develop</a></dd>
        
      </dl>
      
      <br>
      </dl>
    </div>
  </div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>