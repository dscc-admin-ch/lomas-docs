{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "3f18d338",
   "metadata": {},
   "source": [
    "# S3 example"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "01ae30d2",
   "metadata": {},
   "source": [
    "## Step 1: Install the library\n",
    "To interact with the secure server on which the data is stored, one first needs to install the library `lomas-client` on her local developping environment. \n",
    "\n",
    "It can be installed via the pip command:"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "28fbdd79-8c15-49a9-bcf9-fcdeac09d2b5",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-05-01T08:10:09.428907Z",
     "iopub.status.busy": "2025-05-01T08:10:09.428738Z",
     "iopub.status.idle": "2025-05-01T08:10:17.713615Z",
     "shell.execute_reply": "2025-05-01T08:10:17.713088Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\u001b[33mWARNING: pip is configured with locations that require TLS/SSL, however the ssl module in Python is not available.\u001b[0m\u001b[33m\r\n",
      "\u001b[0m\u001b[33mWARNING: Retrying (Retry(total=4, connect=None, read=None, redirect=None, status=None)) after connection broken by 'SSLError(\"Can't connect to HTTPS URL because the SSL module is not available.\")': /simple/lomas-client/\u001b[0m\u001b[33m\r\n",
      "\u001b[0m"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\u001b[33mWARNING: Retrying (Retry(total=3, connect=None, read=None, redirect=None, status=None)) after connection broken by 'SSLError(\"Can't connect to HTTPS URL because the SSL module is not available.\")': /simple/lomas-client/\u001b[0m\u001b[33m\r\n",
      "\u001b[0m"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\u001b[33mWARNING: Retrying (Retry(total=2, connect=None, read=None, redirect=None, status=None)) after connection broken by 'SSLError(\"Can't connect to HTTPS URL because the SSL module is not available.\")': /simple/lomas-client/\u001b[0m\u001b[33m\r\n",
      "\u001b[0m"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\u001b[33mWARNING: Retrying (Retry(total=1, connect=None, read=None, redirect=None, status=None)) after connection broken by 'SSLError(\"Can't connect to HTTPS URL because the SSL module is not available.\")': /simple/lomas-client/\u001b[0m\u001b[33m\r\n",
      "\u001b[0m"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\u001b[33mWARNING: Retrying (Retry(total=0, connect=None, read=None, redirect=None, status=None)) after connection broken by 'SSLError(\"Can't connect to HTTPS URL because the SSL module is not available.\")': /simple/lomas-client/\u001b[0m\u001b[33m\r\n",
      "\u001b[0mCould not fetch URL https://pypi.org/simple/lomas-client/: There was a problem confirming the ssl certificate: HTTPSConnectionPool(host='pypi.org', port=443): Max retries exceeded with url: /simple/lomas-client/ (Caused by SSLError(\"Can't connect to HTTPS URL because the SSL module is not available.\")) - skipping\r\n",
      "\u001b[31mERROR: Could not find a version that satisfies the requirement lomas-client (from versions: none)\u001b[0m\u001b[31m\r\n",
      "\u001b[0m\u001b[31mERROR: No matching distribution found for lomas-client\u001b[0m\u001b[31m\r\n",
      "\u001b[0m"
     ]
    }
   ],
   "source": [
    "!pip install lomas-client"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "6fb569fc",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-05-01T08:10:17.715600Z",
     "iopub.status.busy": "2025-05-01T08:10:17.715246Z",
     "iopub.status.idle": "2025-05-01T08:10:20.240501Z",
     "shell.execute_reply": "2025-05-01T08:10:20.240024Z"
    }
   },
   "outputs": [],
   "source": [
    "from lomas_client.client import Client\n",
    "import numpy as np"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "9c63718b",
   "metadata": {},
   "source": [
    "## Step 2: Initialise the client\n",
    "\n",
    "Once the library is installed, a Client object must be created. It is responsible for sending sending requests to the server and processing responses in the local environment. It enables a seamless interaction with the server. \n",
    "\n",
    "To create the client, one needs to give it a few parameters:\n",
    "- a url: the root application endpoint to the remote secure server.\n",
    "- user_name: her name as registered in the database (Jack)\n",
    "- dataset_name: the name of the dataset that we want to query (TITANIC)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "4ec2f52f",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-05-01T08:10:20.242710Z",
     "iopub.status.busy": "2025-05-01T08:10:20.242175Z",
     "iopub.status.idle": "2025-05-01T08:10:20.250093Z",
     "shell.execute_reply": "2025-05-01T08:10:20.245484Z"
    }
   },
   "outputs": [],
   "source": [
    "DATASET_NAME = \"TITANIC\""
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "74fdc85e",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-05-01T08:10:20.253301Z",
     "iopub.status.busy": "2025-05-01T08:10:20.253067Z",
     "iopub.status.idle": "2025-05-01T08:10:20.259064Z",
     "shell.execute_reply": "2025-05-01T08:10:20.258613Z"
    }
   },
   "outputs": [],
   "source": [
    "# The following would usually be set in the environment by a system administrator\n",
    "# and be tranparent to lomas users.\n",
    "APP_URL = \"http://localhost:48080\"                                    # For local devenv setup\n",
    "# APP_URL = \"http://lomas_server:48080\"                               # For local docker compose setup\n",
    "# APP_URL = \"http://lomas-server.example.com:80\"                 # For Kubernetes deployment\n",
    "USER_NAME = \"Jack\"\n",
    "\n",
    "import os\n",
    "os.environ[\"LOMAS_CLIENT_ID\"] = USER_NAME\n",
    "os.environ[\"LOMAS_CLIENT_SECRET\"] = USER_NAME.lower()\n",
    "os.environ[\"LOMAS_KEYCLOAK_ADDRESS\"] = \"localhost\"                    # For local devenv setup\n",
    "# os.environ[\"LOMAS_KEYCLOAK_ADDRESS\"] = \"keycloak\"                   # For local docker compose setup\n",
    "# os.environ[\"LOMAS_KEYCLOAK_ADDRESS\"] = \"lomas-keycloak.example.com\" # For Kubernetes deployment \n",
    "os.environ[\"LOMAS_KEYCLOAK_PORT\"] = \"4442\"                              # For local deployments\n",
    "# os.environ[\"LOMAS_KEYCLOAK_PORT\"] = \"443\"                           # For Kubernetes deployment\n",
    "os.environ[\"LOMAS_KEYCLOAK_USE_TLS\"] = \"0\"                            # For local deployments\n",
    "# os.environ[\"LOMAS_KEYCLOAK_USE_TLS\"] = \"1\"                          # For Kubernetes deployments\n",
    "os.environ[\"LOMAS_REALM\"] = \"lomas\""
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "e629463f",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-05-01T08:10:20.260320Z",
     "iopub.status.busy": "2025-05-01T08:10:20.260174Z",
     "iopub.status.idle": "2025-05-01T08:10:20.274989Z",
     "shell.execute_reply": "2025-05-01T08:10:20.274663Z"
    }
   },
   "outputs": [],
   "source": [
    "client = Client(url=APP_URL, dataset_name=DATASET_NAME)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "9b9a5f13",
   "metadata": {},
   "source": [
    "## Step 3: Understand the functionnalities of the library"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "c7cb5531",
   "metadata": {},
   "source": [
    "### Getting dataset metadata"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "d15cbe39",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-05-01T08:10:20.276716Z",
     "iopub.status.busy": "2025-05-01T08:10:20.276404Z",
     "iopub.status.idle": "2025-05-01T08:10:20.288635Z",
     "shell.execute_reply": "2025-05-01T08:10:20.288343Z"
    }
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "{'max_ids': 1,\n",
       " 'rows': 887,\n",
       " 'row_privacy': True,\n",
       " 'censor_dims': False,\n",
       " 'columns': {'Pclass': {'private_id': False,\n",
       "   'nullable': False,\n",
       "   'max_partition_length': None,\n",
       "   'max_influenced_partitions': None,\n",
       "   'max_partition_contributions': None,\n",
       "   'type': 'int',\n",
       "   'precision': 32,\n",
       "   'lower': 1,\n",
       "   'upper': 3},\n",
       "  'Name': {'private_id': False,\n",
       "   'nullable': False,\n",
       "   'max_partition_length': None,\n",
       "   'max_influenced_partitions': None,\n",
       "   'max_partition_contributions': None,\n",
       "   'type': 'string'},\n",
       "  'Sex': {'private_id': False,\n",
       "   'nullable': False,\n",
       "   'max_partition_length': None,\n",
       "   'max_influenced_partitions': None,\n",
       "   'max_partition_contributions': None,\n",
       "   'type': 'string',\n",
       "   'cardinality': 2,\n",
       "   'categories': ['male', 'female']},\n",
       "  'Age': {'private_id': False,\n",
       "   'nullable': False,\n",
       "   'max_partition_length': None,\n",
       "   'max_influenced_partitions': None,\n",
       "   'max_partition_contributions': None,\n",
       "   'type': 'float',\n",
       "   'precision': 64,\n",
       "   'lower': 0.1,\n",
       "   'upper': 100.0},\n",
       "  'SibSp': {'private_id': False,\n",
       "   'nullable': False,\n",
       "   'max_partition_length': None,\n",
       "   'max_influenced_partitions': None,\n",
       "   'max_partition_contributions': None,\n",
       "   'type': 'int',\n",
       "   'precision': 32,\n",
       "   'lower': 0,\n",
       "   'upper': 10},\n",
       "  'Parch': {'private_id': False,\n",
       "   'nullable': False,\n",
       "   'max_partition_length': None,\n",
       "   'max_influenced_partitions': None,\n",
       "   'max_partition_contributions': None,\n",
       "   'type': 'int',\n",
       "   'precision': 32,\n",
       "   'lower': 0,\n",
       "   'upper': 10},\n",
       "  'Ticket': {'private_id': False,\n",
       "   'nullable': False,\n",
       "   'max_partition_length': None,\n",
       "   'max_influenced_partitions': None,\n",
       "   'max_partition_contributions': None,\n",
       "   'type': 'string'},\n",
       "  'Fare': {'private_id': False,\n",
       "   'nullable': False,\n",
       "   'max_partition_length': None,\n",
       "   'max_influenced_partitions': None,\n",
       "   'max_partition_contributions': None,\n",
       "   'type': 'float',\n",
       "   'precision': 64,\n",
       "   'lower': 0.0,\n",
       "   'upper': 1000.0},\n",
       "  'Cabin': {'private_id': False,\n",
       "   'nullable': False,\n",
       "   'max_partition_length': None,\n",
       "   'max_influenced_partitions': None,\n",
       "   'max_partition_contributions': None,\n",
       "   'type': 'string'},\n",
       "  'Embarked': {'private_id': False,\n",
       "   'nullable': False,\n",
       "   'max_partition_length': None,\n",
       "   'max_influenced_partitions': None,\n",
       "   'max_partition_contributions': None,\n",
       "   'type': 'string',\n",
       "   'cardinality': 3,\n",
       "   'categories': ['C', 'Q', 'S']},\n",
       "  'Survived': {'private_id': False,\n",
       "   'nullable': False,\n",
       "   'max_partition_length': None,\n",
       "   'max_influenced_partitions': None,\n",
       "   'max_partition_contributions': None,\n",
       "   'type': 'boolean'}}}"
      ]
     },
     "execution_count": 6,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "titanic_metadata = client.get_dataset_metadata()\n",
    "titanic_metadata"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "5a3c899d",
   "metadata": {},
   "source": [
    "### Get a dummy dataset"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "01f4365a",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-05-01T08:10:20.289980Z",
     "iopub.status.busy": "2025-05-01T08:10:20.289819Z",
     "iopub.status.idle": "2025-05-01T08:10:20.292372Z",
     "shell.execute_reply": "2025-05-01T08:10:20.292012Z"
    }
   },
   "outputs": [],
   "source": [
    "NB_ROWS = 200\n",
    "SEED = 0"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "id": "3f553b29",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-05-01T08:10:20.293782Z",
     "iopub.status.busy": "2025-05-01T08:10:20.293498Z",
     "iopub.status.idle": "2025-05-01T08:10:20.360549Z",
     "shell.execute_reply": "2025-05-01T08:10:20.359399Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "(200, 11)\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>Pclass</th>\n",
       "      <th>Name</th>\n",
       "      <th>Sex</th>\n",
       "      <th>Age</th>\n",
       "      <th>SibSp</th>\n",
       "      <th>Parch</th>\n",
       "      <th>Ticket</th>\n",
       "      <th>Fare</th>\n",
       "      <th>Cabin</th>\n",
       "      <th>Embarked</th>\n",
       "      <th>Survived</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>3</td>\n",
       "      <td>o</td>\n",
       "      <td>female</td>\n",
       "      <td>89.690443</td>\n",
       "      <td>6</td>\n",
       "      <td>6</td>\n",
       "      <td>2</td>\n",
       "      <td>858.435326</td>\n",
       "      <td>U</td>\n",
       "      <td>S</td>\n",
       "      <td>True</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>2</td>\n",
       "      <td>D</td>\n",
       "      <td>male</td>\n",
       "      <td>58.373673</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>Z</td>\n",
       "      <td>620.908898</td>\n",
       "      <td>a</td>\n",
       "      <td>C</td>\n",
       "      <td>True</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>2</td>\n",
       "      <td>u</td>\n",
       "      <td>female</td>\n",
       "      <td>4.117800</td>\n",
       "      <td>2</td>\n",
       "      <td>4</td>\n",
       "      <td>h</td>\n",
       "      <td>193.917948</td>\n",
       "      <td>G</td>\n",
       "      <td>S</td>\n",
       "      <td>True</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>1</td>\n",
       "      <td>o</td>\n",
       "      <td>male</td>\n",
       "      <td>71.177534</td>\n",
       "      <td>9</td>\n",
       "      <td>7</td>\n",
       "      <td>a</td>\n",
       "      <td>687.914521</td>\n",
       "      <td>Z</td>\n",
       "      <td>Q</td>\n",
       "      <td>True</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>1</td>\n",
       "      <td>3</td>\n",
       "      <td>male</td>\n",
       "      <td>56.945683</td>\n",
       "      <td>4</td>\n",
       "      <td>10</td>\n",
       "      <td>1</td>\n",
       "      <td>758.999002</td>\n",
       "      <td>W</td>\n",
       "      <td>S</td>\n",
       "      <td>True</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "   Pclass Name     Sex        Age  SibSp  Parch Ticket        Fare Cabin  \\\n",
       "0       3    o  female  89.690443      6      6      2  858.435326     U   \n",
       "1       2    D    male  58.373673      0      0      Z  620.908898     a   \n",
       "2       2    u  female   4.117800      2      4      h  193.917948     G   \n",
       "3       1    o    male  71.177534      9      7      a  687.914521     Z   \n",
       "4       1    3    male  56.945683      4     10      1  758.999002     W   \n",
       "\n",
       "  Embarked  Survived  \n",
       "0        S      True  \n",
       "1        C      True  \n",
       "2        S      True  \n",
       "3        Q      True  \n",
       "4        S      True  "
      ]
     },
     "execution_count": 8,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "df_dummy = client.get_dummy_dataset(\n",
    "    nb_rows = NB_ROWS, \n",
    "    seed = SEED\n",
    ")\n",
    "\n",
    "print(df_dummy.shape)\n",
    "df_dummy.head()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "98e6fda2-dde7-4f8b-a787-c9a1e3571ebe",
   "metadata": {},
   "source": [
    "### Query on dummy dataset"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "243c73e3-daec-45d6-a3c8-ae1d60439ec4",
   "metadata": {},
   "source": [
    "#### Average and number of rows with smartnoise-sql library on remote dummy"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "id": "3946425d",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-05-01T08:10:20.362130Z",
     "iopub.status.busy": "2025-05-01T08:10:20.361966Z",
     "iopub.status.idle": "2025-05-01T08:10:20.365027Z",
     "shell.execute_reply": "2025-05-01T08:10:20.364261Z"
    }
   },
   "outputs": [],
   "source": [
    "# Average Age\n",
    "QUERY = \"SELECT COUNT(*) AS nb_passengers, \\\n",
    "        AVG(Age) AS avg_age \\\n",
    "        FROM df\""
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "id": "90cf2a6d",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-05-01T08:10:20.366226Z",
     "iopub.status.busy": "2025-05-01T08:10:20.366074Z",
     "iopub.status.idle": "2025-05-01T08:10:22.261170Z",
     "shell.execute_reply": "2025-05-01T08:10:22.260709Z"
    }
   },
   "outputs": [],
   "source": [
    "# On the remote server dummy dataframe\n",
    "dummy_res = client.smartnoise_sql.query(\n",
    "    query = QUERY,  \n",
    "    epsilon = 100.0, # make sure to select high values of epsilon and delta to have small differences\n",
    "    delta = 2.0,     # make sure to select high values of epsilon and delta to have small differences\n",
    "    dummy = True, \n",
    "    nb_rows = NB_ROWS,\n",
    "    seed = SEED\n",
    ")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "id": "a30f277e",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-05-01T08:10:22.263159Z",
     "iopub.status.busy": "2025-05-01T08:10:22.262998Z",
     "iopub.status.idle": "2025-05-01T08:10:22.266194Z",
     "shell.execute_reply": "2025-05-01T08:10:22.265885Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Average age in remote dummy: 51.69 years old.\n",
      "Number of rows in remote dummy: 199.\n"
     ]
    }
   ],
   "source": [
    "print(f\"Average age in remote dummy: {np.round(dummy_res.result.df['avg_age'][0], 2)} years old.\")\n",
    "print(f\"Number of rows in remote dummy: {np.round(dummy_res.result.df['nb_passengers'][0], 2)}.\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "324454ed",
   "metadata": {},
   "source": [
    "### Get current budget"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "id": "61a467f3",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-05-01T08:10:22.267836Z",
     "iopub.status.busy": "2025-05-01T08:10:22.267690Z",
     "iopub.status.idle": "2025-05-01T08:10:22.320217Z",
     "shell.execute_reply": "2025-05-01T08:10:22.319875Z"
    }
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "InitialBudgetResponse(initial_epsilon=45.0, initial_delta=0.2)"
      ]
     },
     "execution_count": 12,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "client.get_initial_budget()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "id": "afd22f84",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-05-01T08:10:22.322255Z",
     "iopub.status.busy": "2025-05-01T08:10:22.321466Z",
     "iopub.status.idle": "2025-05-01T08:10:22.372334Z",
     "shell.execute_reply": "2025-05-01T08:10:22.371866Z"
    }
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "SpentBudgetResponse(total_spent_epsilon=0.0, total_spent_delta=0.0)"
      ]
     },
     "execution_count": 13,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "client.get_total_spent_budget()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "05daf5a4",
   "metadata": {},
   "source": [
    "It will also be useful to know what the remaining budget is. Therefore, we call the function `get_remaining_budget`. It just substarcts the total spent budget from the initial budget."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 14,
   "id": "6260cf54",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-05-01T08:10:22.373881Z",
     "iopub.status.busy": "2025-05-01T08:10:22.373677Z",
     "iopub.status.idle": "2025-05-01T08:10:22.427423Z",
     "shell.execute_reply": "2025-05-01T08:10:22.427031Z"
    }
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "RemainingBudgetResponse(remaining_epsilon=45.0, remaining_delta=0.2)"
      ]
     },
     "execution_count": 14,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "client.get_remaining_budget()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "20298e00",
   "metadata": {},
   "source": [
    "As expected, for now the remaining budget is equal to the inital budget."
   ]
  },
  {
   "cell_type": "markdown",
   "id": "b746374c",
   "metadata": {},
   "source": [
    "### Estimate cost of a query\n",
    "Another safeguard is the functionnality to estimate the cost of a query. As in OpenDP and SmartnoiseSQL, the budget that will by used by a query might be slightly different than what is asked by the user. The `estimate cost` function returns the estimated real cost of any query.\n",
    "\n",
    "Again, of course, this will not impact the user's budget."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 15,
   "id": "fd5ed08a",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-05-01T08:10:22.429696Z",
     "iopub.status.busy": "2025-05-01T08:10:22.428868Z",
     "iopub.status.idle": "2025-05-01T08:10:22.431930Z",
     "shell.execute_reply": "2025-05-01T08:10:22.431613Z"
    }
   },
   "outputs": [],
   "source": [
    "EPSILON = 0.5\n",
    "DELTA = 1e-4"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 16,
   "id": "133020c6",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-05-01T08:10:22.433923Z",
     "iopub.status.busy": "2025-05-01T08:10:22.433764Z",
     "iopub.status.idle": "2025-05-01T08:10:24.121430Z",
     "shell.execute_reply": "2025-05-01T08:10:24.120979Z"
    }
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "CostResponse(epsilon=1.5, delta=0.00014999500000001387)"
      ]
     },
     "execution_count": 16,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "client.smartnoise_sql.cost(\n",
    "    query = QUERY, \n",
    "    epsilon = EPSILON, \n",
    "    delta = DELTA\n",
    ")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "e5379edf",
   "metadata": {},
   "source": [
    "### Query on real private dataset with smartnoise-sql."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 17,
   "id": "19e60263",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-05-01T08:10:24.123064Z",
     "iopub.status.busy": "2025-05-01T08:10:24.122884Z",
     "iopub.status.idle": "2025-05-01T08:10:24.174524Z",
     "shell.execute_reply": "2025-05-01T08:10:24.174043Z"
    }
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "RemainingBudgetResponse(remaining_epsilon=45.0, remaining_delta=0.2)"
      ]
     },
     "execution_count": 17,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "client.get_remaining_budget()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 18,
   "id": "69767fac",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-05-01T08:10:24.175964Z",
     "iopub.status.busy": "2025-05-01T08:10:24.175794Z",
     "iopub.status.idle": "2025-05-01T08:10:25.932563Z",
     "shell.execute_reply": "2025-05-01T08:10:25.931761Z"
    }
   },
   "outputs": [],
   "source": [
    "response = client.smartnoise_sql.query(\n",
    "    query = QUERY,  \n",
    "    epsilon = EPSILON, \n",
    "    delta = DELTA,\n",
    "    dummy = False # Optionnal\n",
    ")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "a7a4e2d3-2922-4f95-bdc9-a35c160f157c",
   "metadata": {},
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": 19,
   "id": "6dbbdf93",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-05-01T08:10:25.934282Z",
     "iopub.status.busy": "2025-05-01T08:10:25.934118Z",
     "iopub.status.idle": "2025-05-01T08:10:25.937396Z",
     "shell.execute_reply": "2025-05-01T08:10:25.937010Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Number of passengers in real data: 891.\n",
      "Average age in real data: 29.77.\n"
     ]
    }
   ],
   "source": [
    "nb_passengers = response.result.df['nb_passengers'].iloc[0]\n",
    "print(f\"Number of passengers in real data: {nb_passengers}.\")\n",
    "\n",
    "avg_age = np.round(response.result.df['avg_age'].iloc[0], 2)\n",
    "print(f\"Average age in real data: {avg_age}.\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "b2767e65",
   "metadata": {},
   "source": [
    "After each query on the real dataset, the budget informations are also returned to the researcher. It is possible possible to check the remaining budget again afterwards:"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 20,
   "id": "39701fe5",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-05-01T08:10:25.938806Z",
     "iopub.status.busy": "2025-05-01T08:10:25.938665Z",
     "iopub.status.idle": "2025-05-01T08:10:25.991538Z",
     "shell.execute_reply": "2025-05-01T08:10:25.990874Z"
    }
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "RemainingBudgetResponse(remaining_epsilon=43.5, remaining_delta=0.199850005)"
      ]
     },
     "execution_count": 20,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "client.get_remaining_budget()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "e37c587f",
   "metadata": {},
   "source": [
    "As can be seen in `get_total_spent_budget()`, it is the budget estimated with `estimate_smartnoise_sql_cost()` that was spent."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 21,
   "id": "487f835f",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-05-01T08:10:25.992877Z",
     "iopub.status.busy": "2025-05-01T08:10:25.992732Z",
     "iopub.status.idle": "2025-05-01T08:10:26.042961Z",
     "shell.execute_reply": "2025-05-01T08:10:26.042097Z"
    }
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "SpentBudgetResponse(total_spent_epsilon=1.5, total_spent_delta=0.00014999500000001387)"
      ]
     },
     "execution_count": 21,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "client.get_total_spent_budget()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "04929993",
   "metadata": {},
   "source": [
    "## Step 4: Titanic statistics with opendp"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 22,
   "id": "b9685226",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-05-01T08:10:26.044291Z",
     "iopub.status.busy": "2025-05-01T08:10:26.044145Z",
     "iopub.status.idle": "2025-05-01T08:10:26.046327Z",
     "shell.execute_reply": "2025-05-01T08:10:26.045956Z"
    }
   },
   "outputs": [],
   "source": [
    "import opendp as dp\n",
    "import opendp.transformations as trans\n",
    "import opendp.measurements as meas"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "bbbca191",
   "metadata": {},
   "source": [
    "### Confidence intervals for age over the whole population"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 23,
   "id": "4331d86f",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-05-01T08:10:26.047919Z",
     "iopub.status.busy": "2025-05-01T08:10:26.047770Z",
     "iopub.status.idle": "2025-05-01T08:10:26.052827Z",
     "shell.execute_reply": "2025-05-01T08:10:26.052476Z"
    }
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "{'max_ids': 1,\n",
       " 'rows': 887,\n",
       " 'row_privacy': True,\n",
       " 'censor_dims': False,\n",
       " 'columns': {'Pclass': {'private_id': False,\n",
       "   'nullable': False,\n",
       "   'max_partition_length': None,\n",
       "   'max_influenced_partitions': None,\n",
       "   'max_partition_contributions': None,\n",
       "   'type': 'int',\n",
       "   'precision': 32,\n",
       "   'lower': 1,\n",
       "   'upper': 3},\n",
       "  'Name': {'private_id': False,\n",
       "   'nullable': False,\n",
       "   'max_partition_length': None,\n",
       "   'max_influenced_partitions': None,\n",
       "   'max_partition_contributions': None,\n",
       "   'type': 'string'},\n",
       "  'Sex': {'private_id': False,\n",
       "   'nullable': False,\n",
       "   'max_partition_length': None,\n",
       "   'max_influenced_partitions': None,\n",
       "   'max_partition_contributions': None,\n",
       "   'type': 'string',\n",
       "   'cardinality': 2,\n",
       "   'categories': ['male', 'female']},\n",
       "  'Age': {'private_id': False,\n",
       "   'nullable': False,\n",
       "   'max_partition_length': None,\n",
       "   'max_influenced_partitions': None,\n",
       "   'max_partition_contributions': None,\n",
       "   'type': 'float',\n",
       "   'precision': 64,\n",
       "   'lower': 0.1,\n",
       "   'upper': 100.0},\n",
       "  'SibSp': {'private_id': False,\n",
       "   'nullable': False,\n",
       "   'max_partition_length': None,\n",
       "   'max_influenced_partitions': None,\n",
       "   'max_partition_contributions': None,\n",
       "   'type': 'int',\n",
       "   'precision': 32,\n",
       "   'lower': 0,\n",
       "   'upper': 10},\n",
       "  'Parch': {'private_id': False,\n",
       "   'nullable': False,\n",
       "   'max_partition_length': None,\n",
       "   'max_influenced_partitions': None,\n",
       "   'max_partition_contributions': None,\n",
       "   'type': 'int',\n",
       "   'precision': 32,\n",
       "   'lower': 0,\n",
       "   'upper': 10},\n",
       "  'Ticket': {'private_id': False,\n",
       "   'nullable': False,\n",
       "   'max_partition_length': None,\n",
       "   'max_influenced_partitions': None,\n",
       "   'max_partition_contributions': None,\n",
       "   'type': 'string'},\n",
       "  'Fare': {'private_id': False,\n",
       "   'nullable': False,\n",
       "   'max_partition_length': None,\n",
       "   'max_influenced_partitions': None,\n",
       "   'max_partition_contributions': None,\n",
       "   'type': 'float',\n",
       "   'precision': 64,\n",
       "   'lower': 0.0,\n",
       "   'upper': 1000.0},\n",
       "  'Cabin': {'private_id': False,\n",
       "   'nullable': False,\n",
       "   'max_partition_length': None,\n",
       "   'max_influenced_partitions': None,\n",
       "   'max_partition_contributions': None,\n",
       "   'type': 'string'},\n",
       "  'Embarked': {'private_id': False,\n",
       "   'nullable': False,\n",
       "   'max_partition_length': None,\n",
       "   'max_influenced_partitions': None,\n",
       "   'max_partition_contributions': None,\n",
       "   'type': 'string',\n",
       "   'cardinality': 3,\n",
       "   'categories': ['C', 'Q', 'S']},\n",
       "  'Survived': {'private_id': False,\n",
       "   'nullable': False,\n",
       "   'max_partition_length': None,\n",
       "   'max_influenced_partitions': None,\n",
       "   'max_partition_contributions': None,\n",
       "   'type': 'boolean'}}}"
      ]
     },
     "execution_count": 23,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "titanic_metadata"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 24,
   "id": "ff8cb7b6",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-05-01T08:10:26.054159Z",
     "iopub.status.busy": "2025-05-01T08:10:26.054016Z",
     "iopub.status.idle": "2025-05-01T08:10:26.056184Z",
     "shell.execute_reply": "2025-05-01T08:10:26.055773Z"
    }
   },
   "outputs": [],
   "source": [
    "columns = [\"PassengerId\", \"Pclass\", \"Name\", \"Sex\", \"Age\", \"SibSp\", \"Parch\"]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 25,
   "id": "70b2bdb1",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-05-01T08:10:26.057740Z",
     "iopub.status.busy": "2025-05-01T08:10:26.057385Z",
     "iopub.status.idle": "2025-05-01T08:10:26.060693Z",
     "shell.execute_reply": "2025-05-01T08:10:26.060326Z"
    }
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "(0.1, 100.0)"
      ]
     },
     "execution_count": 25,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "age_min = titanic_metadata['columns']['Age']['lower']\n",
    "age_max = titanic_metadata['columns']['Age']['upper']\n",
    "age_min, age_max"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 26,
   "id": "75e4933b",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-05-01T08:10:26.062027Z",
     "iopub.status.busy": "2025-05-01T08:10:26.061867Z",
     "iopub.status.idle": "2025-05-01T08:10:26.067535Z",
     "shell.execute_reply": "2025-05-01T08:10:26.066724Z"
    }
   },
   "outputs": [],
   "source": [
    "age_transformation_pipeline = (\n",
    "    trans.make_split_dataframe(separator=\",\", col_names=columns) >>\n",
    "    trans.make_select_column(key=\"Age\", TOA=str) >>\n",
    "    trans.then_cast_default(TOA=float) >>\n",
    "    trans.then_clamp(bounds=(age_min, age_max)) >>\n",
    "    trans.then_resize(size=nb_passengers.tolist(), constant=avg_age) >>\n",
    "    trans.then_variance()\n",
    ")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 27,
   "id": "8041a647",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-05-01T08:10:26.068956Z",
     "iopub.status.busy": "2025-05-01T08:10:26.068798Z",
     "iopub.status.idle": "2025-05-01T08:10:26.212381Z",
     "shell.execute_reply": "2025-05-01T08:10:26.211514Z"
    },
    "tags": [
     "raises-exception"
    ]
   },
   "outputs": [
    {
     "ename": "TypeError",
     "evalue": "Opendp_pipeline must either of type Measurement or LazyFrame, found <class 'opendp.mod.Transformation'>",
     "output_type": "error",
     "traceback": [
      "\u001b[31m---------------------------------------------------------------------------\u001b[39m",
      "\u001b[31mTypeError\u001b[39m                                 Traceback (most recent call last)",
      "\u001b[36mCell\u001b[39m\u001b[36m \u001b[39m\u001b[32mIn[27]\u001b[39m\u001b[32m, line 2\u001b[39m\n\u001b[32m      1\u001b[39m \u001b[38;5;66;03m# Expect to fail !!!\u001b[39;00m\n\u001b[32m----> \u001b[39m\u001b[32m2\u001b[39m \u001b[43mclient\u001b[49m\u001b[43m.\u001b[49m\u001b[43mopendp\u001b[49m\u001b[43m.\u001b[49m\u001b[43mquery\u001b[49m\u001b[43m(\u001b[49m\n\u001b[32m      3\u001b[39m \u001b[43m    \u001b[49m\u001b[43mopendp_pipeline\u001b[49m\u001b[43m \u001b[49m\u001b[43m=\u001b[49m\u001b[43m \u001b[49m\u001b[43mage_transformation_pipeline\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m      4\u001b[39m \u001b[43m    \u001b[49m\u001b[43mdummy\u001b[49m\u001b[43m=\u001b[49m\u001b[38;5;28;43;01mTrue\u001b[39;49;00m\n\u001b[32m      5\u001b[39m \u001b[43m)\u001b[49m\n",
      "\u001b[36mFile \u001b[39m\u001b[32m~/work/sdd-poc-server/client/lomas_client/libraries/opendp.py:141\u001b[39m, in \u001b[36mOpenDPClient.query\u001b[39m\u001b[34m(self, opendp_pipeline, fixed_delta, mechanism, dummy, nb_rows, seed)\u001b[39m\n\u001b[32m    104\u001b[39m \u001b[38;5;28;01mdef\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34mquery\u001b[39m(\n\u001b[32m    105\u001b[39m     \u001b[38;5;28mself\u001b[39m,\n\u001b[32m    106\u001b[39m     opendp_pipeline: dp.Measurement | pl.LazyFrame,\n\u001b[32m   (...)\u001b[39m\u001b[32m    111\u001b[39m     seed: \u001b[38;5;28mint\u001b[39m = DUMMY_SEED,\n\u001b[32m    112\u001b[39m ) -> QueryResponse | \u001b[38;5;28;01mNone\u001b[39;00m:\n\u001b[32m    113\u001b[39m \u001b[38;5;250m    \u001b[39m\u001b[33;03m\"\"\"This function executes an OpenDP query.\u001b[39;00m\n\u001b[32m    114\u001b[39m \n\u001b[32m    115\u001b[39m \u001b[33;03m    Args:\u001b[39;00m\n\u001b[32m   (...)\u001b[39m\u001b[32m    139\u001b[39m \u001b[33;03m            containing the deserialized pipeline result.\u001b[39;00m\n\u001b[32m    140\u001b[39m \u001b[33;03m    \"\"\"\u001b[39;00m\n\u001b[32m--> \u001b[39m\u001b[32m141\u001b[39m     body_json = \u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43m_get_opendp_request_body\u001b[49m\u001b[43m(\u001b[49m\n\u001b[32m    142\u001b[39m \u001b[43m        \u001b[49m\u001b[43mopendp_pipeline\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    143\u001b[39m \u001b[43m        \u001b[49m\u001b[43mfixed_delta\u001b[49m\u001b[43m=\u001b[49m\u001b[43mfixed_delta\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    144\u001b[39m \u001b[43m        \u001b[49m\u001b[43mmechanism\u001b[49m\u001b[43m=\u001b[49m\u001b[43mmechanism\u001b[49m\u001b[43m,\u001b[49m\n\u001b[32m    145\u001b[39m \u001b[43m    \u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    147\u001b[39m     request_model: \u001b[38;5;28mtype\u001b[39m[OpenDPRequestModel]\n\u001b[32m    148\u001b[39m     \u001b[38;5;28;01mif\u001b[39;00m dummy:\n",
      "\u001b[36mFile \u001b[39m\u001b[32m~/work/sdd-poc-server/client/lomas_client/libraries/opendp.py:61\u001b[39m, in \u001b[36mOpenDPClient._get_opendp_request_body\u001b[39m\u001b[34m(self, opendp_pipeline, fixed_delta, mechanism)\u001b[39m\n\u001b[32m     59\u001b[39m     body_json[\u001b[33m\"\u001b[39m\u001b[33mpipeline_type\u001b[39m\u001b[33m\"\u001b[39m] = \u001b[33m\"\u001b[39m\u001b[33mpolars\u001b[39m\u001b[33m\"\u001b[39m\n\u001b[32m     60\u001b[39m \u001b[38;5;28;01melse\u001b[39;00m:\n\u001b[32m---> \u001b[39m\u001b[32m61\u001b[39m     \u001b[38;5;28;01mraise\u001b[39;00m \u001b[38;5;167;01mTypeError\u001b[39;00m(\n\u001b[32m     62\u001b[39m         \u001b[33mf\u001b[39m\u001b[33m\"\u001b[39m\u001b[33mOpendp_pipeline must either of type Measurement\u001b[39m\u001b[33m\"\u001b[39m\n\u001b[32m     63\u001b[39m         \u001b[33mf\u001b[39m\u001b[33m\"\u001b[39m\u001b[33m or LazyFrame, found \u001b[39m\u001b[38;5;132;01m{\u001b[39;00m\u001b[38;5;28mtype\u001b[39m(opendp_pipeline)\u001b[38;5;132;01m}\u001b[39;00m\u001b[33m\"\u001b[39m\n\u001b[32m     64\u001b[39m     )\n\u001b[32m     66\u001b[39m \u001b[38;5;28;01mreturn\u001b[39;00m body_json\n",
      "\u001b[31mTypeError\u001b[39m: Opendp_pipeline must either of type Measurement or LazyFrame, found <class 'opendp.mod.Transformation'>"
     ]
    }
   ],
   "source": [
    "# Expect to fail !!!\n",
    "client.opendp.query(\n",
    "    opendp_pipeline = age_transformation_pipeline,\n",
    "    dummy=True\n",
    ")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "d06c59dc",
   "metadata": {},
   "source": [
    "This is because the server will only allow measurement pipeline with differentially private results. We add Laplacian noise to the pipeline and should be able to instantiate the pipeline."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 28,
   "id": "b8162859",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-05-01T08:10:26.214012Z",
     "iopub.status.busy": "2025-05-01T08:10:26.213843Z",
     "iopub.status.idle": "2025-05-01T08:10:26.217196Z",
     "shell.execute_reply": "2025-05-01T08:10:26.216225Z"
    }
   },
   "outputs": [],
   "source": [
    "var_age_transformation_pipeline = (\n",
    "    age_transformation_pipeline >>\n",
    "    meas.then_laplace(scale=5.0)\n",
    ")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "fc7e0ecd",
   "metadata": {},
   "source": [
    "Now that there is a measurement, one is able to apply the pipeline on the dummy dataset of the server."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 29,
   "id": "df61bce0",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-05-01T08:10:26.218601Z",
     "iopub.status.busy": "2025-05-01T08:10:26.218446Z",
     "iopub.status.idle": "2025-05-01T08:10:27.879000Z",
     "shell.execute_reply": "2025-05-01T08:10:27.878555Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Dummy result for variance: 64.9\n"
     ]
    }
   ],
   "source": [
    "dummy_var_res = client.opendp.query(\n",
    "    opendp_pipeline = var_age_transformation_pipeline, \n",
    "    dummy=True\n",
    ")\n",
    "print(f\"Dummy result for variance: {np.round(dummy_var_res.result.value, 2)}\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "ded11ac4",
   "metadata": {},
   "source": [
    "With opendp, the function `estimate_opendp_cost` is particularly useful to estimate the used `epsilon` and `delta` based on the `scale` value."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 30,
   "id": "7ae7f735",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-05-01T08:10:27.880704Z",
     "iopub.status.busy": "2025-05-01T08:10:27.880458Z",
     "iopub.status.idle": "2025-05-01T08:10:28.682791Z",
     "shell.execute_reply": "2025-05-01T08:10:28.682310Z"
    }
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "CostResponse(epsilon=2.240181818190626, delta=0.0)"
      ]
     },
     "execution_count": 30,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "cost_res = client.opendp.cost(\n",
    "    opendp_pipeline = var_age_transformation_pipeline\n",
    ")\n",
    "cost_res"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "1c791d36",
   "metadata": {},
   "source": [
    "One can now execute the query on the real dataset."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 31,
   "id": "085555a5",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-05-01T08:10:28.684449Z",
     "iopub.status.busy": "2025-05-01T08:10:28.684141Z",
     "iopub.status.idle": "2025-05-01T08:10:29.572239Z",
     "shell.execute_reply": "2025-05-01T08:10:29.571481Z"
    }
   },
   "outputs": [],
   "source": [
    "var_res = client.opendp.query(\n",
    "    opendp_pipeline = var_age_transformation_pipeline, \n",
    ")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 32,
   "id": "674332e7",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-05-01T08:10:29.573887Z",
     "iopub.status.busy": "2025-05-01T08:10:29.573718Z",
     "iopub.status.idle": "2025-05-01T08:10:29.577170Z",
     "shell.execute_reply": "2025-05-01T08:10:29.576773Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Number of passengers: 891 (from previous smartnoise-sql query).\n",
      "Average age: 29.77 (from previous smartnoise-sql query).\n",
      "Variance of age: 204.025 (from opendp query).\n"
     ]
    }
   ],
   "source": [
    "print(f\"Number of passengers: {nb_passengers} (from previous smartnoise-sql query).\")\n",
    "\n",
    "print(f\"Average age: {np.round(avg_age, 2)} (from previous smartnoise-sql query).\")\n",
    "\n",
    "var_age = var_res.result.value\n",
    "print(f\"Variance of age: {np.round(var_age, 3)} (from opendp query).\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 33,
   "id": "f72b19d0",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-05-01T08:10:29.578528Z",
     "iopub.status.busy": "2025-05-01T08:10:29.578381Z",
     "iopub.status.idle": "2025-05-01T08:10:29.581101Z",
     "shell.execute_reply": "2025-05-01T08:10:29.580695Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Standard error of age: 0.48.\n"
     ]
    }
   ],
   "source": [
    "# Get standard error\n",
    "standard_error = np.sqrt(var_age/nb_passengers)\n",
    "print(f\"Standard error of age: {np.round(standard_error, 2)}.\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 34,
   "id": "62630a03",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-05-01T08:10:29.582606Z",
     "iopub.status.busy": "2025-05-01T08:10:29.582349Z",
     "iopub.status.idle": "2025-05-01T08:10:29.586283Z",
     "shell.execute_reply": "2025-05-01T08:10:29.585442Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "The 95% confidence interval of the age of all passengers is [28.83, 30.71].\n"
     ]
    }
   ],
   "source": [
    " # Compute the 95% confidence interval\n",
    "ZSCORE = 1.96\n",
    "lower_bound = np.round(avg_age - ZSCORE*standard_error, 2)\n",
    "upper_bound = np.round(avg_age + ZSCORE*standard_error, 2)\n",
    "print(f\"The 95% confidence interval of the age of all passengers is [{lower_bound}, {upper_bound}].\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "3bcb4225-59c3-4e58-9be5-b9fae115b99d",
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.12.9"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
